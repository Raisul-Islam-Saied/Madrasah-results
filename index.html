<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আবদুর রাজ্জাক দাখিল মাদ্রাসা - রেজাল্ট ও মেরিট</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 6px solid #00796b;
        }

        /* Header */
        header {
            background-color: #e0f2f1;
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #b2dfdb;
        }
        header h1 { margin: 0; color: #00695c; font-size: 28px; }
        header p { margin: 5px 0 0; color: #555; }

        /* Steps */
        .step-container { padding: 25px; }
        .hidden { display: none; }

        h3 { border-left: 5px solid #00796b; padding-left: 10px; color: #333; }

        /* Step 1: Subject Selection */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .sub-card {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sub-card label { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .sub-card input[type="checkbox"] { transform: scale(1.3); accent-color: #00796b; }
        .fm-input { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

        /* Step 2: Marks Input */
        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .marks-table th { background: #00796b; color: white; padding: 10px; text-align: left; }
        .marks-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .input-mark { width: 90%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; display: block; }
        .input-mark:focus { border-color: #00796b; outline: none; background: #e0f2f1; }

        /* Buttons */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-size: 18px; cursor: pointer; font-weight: bold; color: white;
            transition: 0.3s; font-family: inherit;
        }
        .btn-next { background: #00796b; }
        .btn-next:hover { background: #004d40; }
        .btn-calc { background: #d81b60; margin-bottom: 10px; }
        .btn-back { background: #546e7a; width: auto; padding: 8px 20px; font-size: 14px; margin-bottom: 10px; }
        .btn-add { background: #0288d1; width: auto; padding: 10px 20px; font-size: 14px; margin-bottom: 20px; }

        /* Result & Merit Area */
        #result-area {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        /* New Table Style for List */
        .list-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: center; }
        .list-table th { background: #37474f; color: white; padding: 12px; border: 1px solid #37474f; }
        .list-table td { border: 1px solid #ddd; padding: 10px; font-size: 18px; }
        
        .pass-row { background-color: #fff; color: #333; }
        .fail-row { background-color: #ffebee; color: #c62828; } /* Light red for fail */

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>আবদুর রাজ্জাক দাখিল মাদ্রাসা</h1>
        <p>ফলাফল ও মেধা তালিকা সংরক্ষণ সিস্টেম</p>
    </header>

    <div id="step1" class="step-container">
        <h3>ধাপ ১: বিষয় নির্বাচন ও পূর্ণমান নির্ধারণ</h3>
        
        <div class="subject-grid" id="subject-selection-area"></div>
        <button class="btn btn-add" onclick="addNewSubject()">+ নতুন বিষয় এড করুন</button>
        <button class="btn btn-next" onclick="goToStep2()">পরবর্তী ধাপ (নম্বর প্রদান) &raquo;</button>
    </div>

    <div id="step2" class="step-container hidden">
        <button class="btn btn-back" onclick="goBackToStep1()">&laquo; বিষয় পরিবর্তন করুন</button>
        <h3>ধাপ ২: প্রাপ্ত নম্বর এন্ট্রি</h3>
        <p style="color: #d81b60; font-size: 12px; margin-top:0;">* ফলাফল দেখার পর ঘরগুলো অটোমেটিক খালি হয়ে যাবে।</p>
        
        <table class="marks-table">
            <thead>
                <tr>
                    <th style="width: 50%">বিষয়</th>
                    <th style="width: 25%">পূর্ণমান</th>
                    <th style="width: 25%">নম্বর</th>
                </tr>
            </thead>
            <tbody id="input-rows"></tbody>
        </table>

        <button class="btn btn-calc" onclick="addStudentResult()">ফলাফল দেখুন এবং তালিকায় যোগ করুন</button>

        <div id="merit-list-section" style="display: none;">
            <h3 style="text-align: center; color: #37474f; margin-top: 30px;">সংরক্ষিত মেধা তালিকা</h3>
            <table class="list-table">
                <thead>
                    <tr>
                        <th style="width: 15%">সিরিয়াল</th>
                        <th style="width: 30%">মোট নম্বর</th>
                        <th style="width: 30%">জিপিএ (GPA)</th>
                        <th style="width: 25%">মেরিট</th>
                    </tr>
                </thead>
                <tbody id="student-rows">
                    </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    // Global Storage
    let allStudents = [];
    let entrySerial = 1;

    const subjectsDB = [
        { id: 'quran', name: 'কুরআন মাজিদ', def: 100 },
        { id: 'akaid', name: 'আকাইদ ও ফিকহ', def: 100 },
        { id: 'hadith', name: 'হাদিস শরীফ', def: 100 },
        { id: 'arb1', name: 'আরবি ১ম পত্র', def: 100 },
        { id: 'arb2', name: 'আরবি ২য় পত্র', def: 100 },
        { id: 'ban1', name: 'বাংলা ১ম পত্র', def: 100 },
        { id: 'ban2', name: 'বাংলা ২য় পত্র', def: 100 },
        { id: 'eng1', name: 'ইংরেজি ১ম পত্র', def: 100 },
        { id: 'eng2', name: 'ইংরেজি ২য় পত্র', def: 100 },
        { id: 'math', name: 'গণিত', def: 100 },
        { id: 'bgs', name: 'বাংলাদেশ ও বিশ্বপরিচয়', def: 100 },
        { id: 'sci', name: 'বিজ্ঞান', def: 100 },
        { id: 'agri', name: 'কৃষি শিক্ষা', def: 100 },
        { id: 'ict', name: 'তথ্য ও যোগাযোগ প্রযুক্তি', def: 50 }
    ];

    let selectedSubjects = [];

    window.onload = function() {
        const container = document.getElementById('subject-selection-area');
        subjectsDB.forEach((sub, index) => {
            const isChecked = index < 2 ? 'checked' : ''; 
            createSubjectCard(sub.name, sub.def, isChecked);
        });
    };

    function createSubjectCard(name, fullMark, checkedAttr) {
        const container = document.getElementById('subject-selection-area');
        const div = document.createElement('div');
        div.className = 'sub-card';
        div.innerHTML = `
            <label>
                <input type="checkbox" class="sub-check" data-name="${name}" ${checkedAttr}>
                ${name}
            </label>
            <input type="number" class="fm-input" value="${fullMark}" placeholder="Full">
        `;
        container.appendChild(div);
    }

    function addNewSubject() {
        let name = prompt("নতুন বিষয়ের নাম লিখুন:");
        if (name && name.trim() !== "") {
            createSubjectCard(name, 100, 'checked');
        }
    }

    function goToStep2() {
        selectedSubjects = [];
        const cards = document.querySelectorAll('.sub-card');
        
        cards.forEach(card => {
            const checkbox = card.querySelector('.sub-check');
            const fullMark = card.querySelector('.fm-input').value;
            
            if(checkbox.checked) {
                selectedSubjects.push({
                    name: checkbox.getAttribute('data-name'),
                    full: parseInt(fullMark) || 100
                });
            }
        });

        if(selectedSubjects.length === 0) {
            alert("অনুগ্রহ করে অন্তত একটি বিষয় নির্বাচন করুন।");
            return;
        }

        renderInputRows();
        
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        
        setTimeout(() => {
            const inputs = document.querySelectorAll('.input-mark');
            if(inputs.length > 0) inputs[0].focus();
        }, 100);
    }

    function goBackToStep1() {
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('merit-list-section').style.display = 'none';
        allStudents = []; 
        entrySerial = 1;
    }

    function renderInputRows() {
        const tbody = document.getElementById('input-rows');
        tbody.innerHTML = '';

        selectedSubjects.forEach((sub, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${sub.name}</td>
                <td style="text-align:center; font-weight:bold; color:#666;">${sub.full}</td>
                <td>
                    <input type="number" class="input-mark" data-full="${sub.full}" placeholder="Mark" oninput="handleInput(this, ${index})">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function handleInput(input, index) {
        let val = input.value;
        const fullMark = parseFloat(input.getAttribute('data-full'));
        const allInputs = document.querySelectorAll('.input-mark');

        if (val !== "" && parseFloat(val) > fullMark) {
            alert(`দুঃখিত! এই বিষয়ের পূর্ণমান ${fullMark}। এর বেশি নম্বর দেওয়া যাবে না।`);
            input.value = ""; 
            return;
        }

        if (val.length >= 2 && val !== "10") { 
            if (index + 1 < allInputs.length) {
                setTimeout(() => allInputs[index + 1].focus(), 100); 
            }
        }
    }

    function getGP(percentage) {
        if (percentage >= 80) return 5.00;
        else if (percentage >= 70) return 4.00;
        else if (percentage >= 60) return 3.50;
        else if (percentage >= 50) return 3.00;
        else if (percentage >= 40) return 2.00;
        else if (percentage >= 33) return 1.00;
        else return 0.00;
    }

    // MAIN LOGIC FUNCTION
    function addStudentResult() {
        const inputs = document.querySelectorAll('.input-mark');
        let totalObtained = 0;
        let totalGP = 0;
        let failCount = 0;
        let subjectCount = inputs.length;

        for(let inp of inputs) {
            if(inp.value === "") {
                alert("সব বিষয়ের নম্বর পূরণ করুন!");
                return;
            }
        }

        inputs.forEach(inp => {
            let marks = parseFloat(inp.value);
            let full = parseFloat(inp.getAttribute('data-full'));
            
            totalObtained += marks;

            let percent = (marks / full) * 100;
            let gp = getGP(percent);
            
            totalGP += gp;

            if(percent < 33) failCount++;
        });

        let finalGPA = (totalGP / subjectCount).toFixed(2);
        if(finalGPA > 5.00) finalGPA = "5.00";

        // Create Student Object
        const isPass = failCount === 0;
        
        const newStudent = {
            id: entrySerial, // সিরিয়াল ঠিক রাখার জন্য ID
            total: totalObtained,
            gpa: parseFloat(finalGPA),
            isPass: isPass,
            failCount: failCount,
            merit: 0 // পরে হিসাব হবে
        };

        // Add to main list
        allStudents.push(newStudent);
        entrySerial++;

        // RE-CALCULATE MERIT POSITIONS
        calculateMeritPositions();

        // RENDER TABLE (SERIAL WISE)
        renderStudentTable();

        // Show Section & Clear Inputs
        document.getElementById('merit-list-section').style.display = 'block';
        inputs.forEach(inp => inp.value = '');
    }

    function calculateMeritPositions() {
        // Create a copy to sort, so original order is preserved
        let sortedList = [...allStudents];

        sortedList.sort((a, b) => {
            // Rule 1: Pass comes before Fail
            if (a.isPass && !b.isPass) return -1;
            if (!a.isPass && b.isPass) return 1;

            // Rule 2: If both Pass
            if (a.isPass && b.isPass) {
                // Higher GPA first
                if (b.gpa !== a.gpa) return b.gpa - a.gpa;
                // Then Higher Total Marks
                return b.total - a.total;
            }

            // Rule 3: If both Fail
            if (!a.isPass && !b.isPass) {
                // Higher Total Marks first (even if failed)
                return b.total - a.total;
            }
        });

        // Assign Rank based on sorted index
        sortedList.forEach((student, index) => {
            // Find this student in the original array and update merit
            const originalStudent = allStudents.find(s => s.id === student.id);
            originalStudent.merit = index + 1;
        });
    }

    function renderStudentTable() {
        const tbody = document.getElementById('student-rows');
        tbody.innerHTML = '';

        // Render strictly by ID/Entry Order (allStudents array is already in entry order)
        allStudents.forEach(student => {
            let rowClass = student.isPass ? "pass-row" : "fail-row";
            let gpaDisplay = student.isPass ? student.gpa.toFixed(2) : "0.00 (Fail)";

            const row = `
                <tr class="${rowClass}">
                    <td>${student.id}</td>
                    <td>${student.total}</td>
                    <td>${gpaDisplay}</td>
                    <td style="font-weight:bold;">${student.merit}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
</script>

</body>
            </html>
