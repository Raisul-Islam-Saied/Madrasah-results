<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ - ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 6px solid #00796b;
            padding-bottom: 20px;
        }

        /* Header */
        header {
            background-color: #e0f2f1;
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #b2dfdb;
        }
        header h1 { margin: 0; color: #00695c; font-size: 28px; }
        header p { margin: 5px 0 0; color: #555; }

        /* Steps */
        .step-container { padding: 25px; }
        .hidden { display: none; }

        h3 { border-left: 5px solid #00796b; padding-left: 10px; color: #333; }

        /* Subject Grid */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .sub-card {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sub-card label { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .sub-card input[type="checkbox"] { transform: scale(1.3); accent-color: #00796b; }
        .fm-input { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

        /* Marks Table */
        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .marks-table th { background: #00796b; color: white; padding: 10px; text-align: left; }
        .marks-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .input-mark { width: 90%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; display: block; }
        .input-mark:focus { border-color: #00796b; outline: none; background: #e0f2f1; }

        /* Buttons */
        .btn {
            padding: 12px; border: none; border-radius: 6px; font-size: 16px; 
            cursor: pointer; font-weight: bold; color: white; transition: 0.3s;
        }
        .btn-next { background: #00796b; width: 100%; }
        .btn-calc { background: #d81b60; width: 100%; margin-bottom: 10px; }
        .btn-back { background: #546e7a; padding: 8px 20px; margin-bottom: 10px; width: auto; }
        .btn-add { background: #0288d1; padding: 10px 20px; margin-bottom: 20px; width: auto; }
        
        .btn-print { background: #455a64; margin-top: 15px; width: 48%; }
        .btn-reset { background: #c62828; margin-top: 15px; width: 48%; float: right; }

        /* Action Buttons (Always Visible) */
        .action-col { white-space: nowrap; }
        .action-btn { padding: 6px 10px; font-size: 14px; margin: 2px; border-radius: 4px; border: none; cursor: pointer; color: white; }
        .btn-edit { background: #fbc02d; color: black; }
        .btn-del { background: #e53935; }

        /* Result Preview */
        #result-area {
            background: #e8f5e9; padding: 20px; border-radius: 8px; margin-top: 20px; display: none;
        }
        .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .res-box { background: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .res-box strong { display: block; font-size: 22px; color: #333; }
        .full-width { grid-column: span 2; }

        /* Merit List Table */
        .list-table { width: 100%; border-collapse: collapse; margin-top: 10px; text-align: center; }
        .list-table th { background: #37474f; color: white; padding: 8px; border: 1px solid #37474f; font-size: 14px; }
        .list-table td { border: 1px solid #ddd; padding: 8px; font-size: 15px; }
        
        .row-pass { background-color: #fff; color: #333; }
        .row-fail { background-color: #ffebee; color: #c62828; } 

        /* PRINT SETTINGS (Fixed) */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .container { box-shadow: none; border: none; max-width: 100%; width: 100%; padding: 0; }
            
            /* Hide non-print elements */
            .step-container, .btn, #result-area, .marks-table, #step1 { display: none !important; }
            
            /* Show Header & Merit Section */
            header { display: block !important; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            #merit-list-section { display: block !important; margin-top: 0; border: none; }
            
            /* Table Styling for Print */
            .list-table { width: 100%; font-size: 11px; }
            .list-table th, .list-table td { border: 1px solid #000 !important; padding: 4px; color: black; }
            .list-table th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            
            /* Hide Action Column in Print */
            .action-col { display: none !important; }
            
            /* Pass/Fail Colors */
            .row-fail { background-color: #ffebee !important; -webkit-print-color-adjust: exact; }
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
        <p>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡ßÄ ‡¶ì ‡¶Æ‡ßá‡¶ß‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
    </header>

    <div id="step1" class="step-container">
        <h3>‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ì ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">‡¶Ø‡ßá ‡¶¨‡¶ø‡¶∑‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®‡•§</p>
        
        <div class="subject-grid" id="subject-selection-area"></div>

        <button class="btn btn-add" onclick="addNewSubject()">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn btn-next" onclick="goToStep2()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™ (‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®) &raquo;</button>
        <br><br><small style="color: blue;">* ‡¶Ö‡¶ü‡ßã ‡¶∏‡ßá‡¶≠ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá‡•§</small>
    </div>

    <div id="step2" class="step-container hidden">
        <button class="btn btn-back" onclick="goBackToStep1()">&laquo; ‡¶¨‡¶ø‡¶∑‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        <h3>‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
        <p style="color: #d81b60; font-size: 12px; margin-top:0;">* ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶ò‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
        
        <table class="marks-table">
            <thead>
                <tr>
                    <th style="width: 50%">‡¶¨‡¶ø‡¶∑‡ßü</th>
                    <th style="width: 25%">‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</th>
                    <th style="width: 25%">‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                </tr>
            </thead>
            <tbody id="input-rows"></tbody>
        </table>

        <button class="btn btn-calc" onclick="calculateFinalResult()">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>

        <div id="result-area">
            <h4 style="text-align:center; margin:0 0 10px 0;">‡¶∏‡¶¶‡ßç‡¶Ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h4>
            <div class="result-grid">
                <div class="res-box"><span>‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span><strong id="r-total">0</strong></div>
                <div class="res-box"><span>‡¶ú‡¶ø‡¶™‡¶ø‡¶è</span><strong id="r-gpa">0.00</strong></div>
                <div class="res-box full-width" style="background: #004d40; color: white;">
                    <span>‡¶ó‡ßç‡¶∞‡ßá‡¶°</span><strong style="color: yellow;" id="r-grade">--</strong>
                </div>
            </div>
        </div>

        <div id="merit-list-section" style="display: none; border-top: 2px dashed #bbb; margin-top: 30px; padding-top: 10px;">
            <h3 style="text-align: center; color: #37474f;">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
            
            <div style="overflow-x: auto;">
                <table class="list-table">
                    <thead>
                        <tr>
                            <th>‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</th>
                            <th>‡¶ü‡ßã‡¶ü‡¶æ‡¶≤</th>
                            <th>‡¶ó‡ßú</th>
                            <th>‡¶´‡ßÅ‡¶≤ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï</th>
                            <th>‡¶π‡¶æ‡¶á‡ßü‡ßá‡¶∏‡ßç‡¶ü</th>
                            <th>‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶ú‡¶ø‡¶™‡¶ø</th>
                            <th>‡¶ú‡¶ø‡¶™‡¶ø‡¶è</th>
                            <th>‡¶ó‡ßç‡¶∞‡ßá‡¶°</th>
                            <th>‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü</th>
                            <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                            <th class="action-col">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="student-rows"></tbody>
                </table>
            </div>

            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn btn-reset" onclick="clearAllData()">üóëÔ∏è ‡¶∏‡¶¨ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
        </div>
    </div>
</div>

<script>
    // Global Variables
    let allStudents = [];
    let entrySerial = 1;
    let selectedSubjects = [];

    const subjectsDB = [
        { name: '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶Æ‡¶æ‡¶ú‡¶ø‡¶¶', def: 100 },
        { name: '‡¶Ü‡¶ï‡¶æ‡¶á‡¶¶ ‡¶ì ‡¶´‡¶ø‡¶ï‡¶π', def: 100 },
        { name: '‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶∂‡¶∞‡ßÄ‡¶´', def: 100 },
        { name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { name: '‡¶ó‡¶£‡¶ø‡¶§', def: 100 },
        { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶™‡¶∞‡¶ø‡¶ö‡ßü', def: 100 },
        { name: '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', def: 100 },
        { name: '‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', def: 100 },
        { name: '‡¶Ü‡¶á‡¶∏‡¶ø‡¶ü‡¶ø', def: 50 }
    ];

    window.onload = function() { loadData(); };

    // --- DOM Functions ---
    function createSubjectCard(name, fullMark, checkedAttr) {
        const container = document.getElementById('subject-selection-area');
        const div = document.createElement('div');
        div.className = 'sub-card';
        div.innerHTML = `
            <label><input type="checkbox" class="sub-check" data-name="${name}" ${checkedAttr}> ${name}</label>
            <input type="number" class="fm-input" value="${fullMark}">
        `;
        container.appendChild(div);
    }

    function addNewSubject() {
        let name = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:");
        if (name && name.trim() !== "") createSubjectCard(name, 100, 'checked');
    }

    function goToStep2() {
        selectedSubjects = [];
        const cards = document.querySelectorAll('.sub-card');
        cards.forEach(card => {
            const chk = card.querySelector('.sub-check');
            const fm = card.querySelector('.fm-input').value;
            if(chk.checked) {
                selectedSubjects.push({ name: chk.getAttribute('data-name'), full: parseInt(fm)||100 });
            }
        });

        if(selectedSubjects.length === 0) { alert("‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!"); return; }

        saveData();
        renderInputRows();
        
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        
        setTimeout(() => document.querySelector('.input-mark')?.focus(), 100);
    }

    function goBackToStep1() {
        if(confirm("‡¶¨‡¶ø‡¶∑‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            localStorage.removeItem('madrasah_subjects'); // ‡¶∏‡¶æ‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            location.reload();
        }
    }

    // --- Input & Calculation ---
    function renderInputRows() {
        const tbody = document.getElementById('input-rows');
        tbody.innerHTML = '';
        selectedSubjects.forEach((sub, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td>${sub.name}</td>
                    <td style="text-align:center;">${sub.full}</td>
                    <td><input type="number" class="input-mark" data-full="${sub.full}" oninput="handleInput(this, ${idx})"></td>
                </tr>
            `;
        });
    }

    function handleInput(input, index) {
        let val = parseFloat(input.value);
        let max = parseFloat(input.getAttribute('data-full'));
        if(val > max) { alert(`‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ${max}`); input.value = ""; return; }
        
        if(input.value.length >= 2 && input.value !== "10") {
            const inputs = document.querySelectorAll('.input-mark');
            if(index + 1 < inputs.length) setTimeout(() => inputs[index+1].focus(), 100);
        }
    }

    function getGP(percent) {
        if (percent >= 80) return 5.00;
        else if (percent >= 70) return 4.00;
        else if (percent >= 60) return 3.50;
        else if (percent >= 50) return 3.00;
        else if (percent >= 40) return 2.00;
        else if (percent >= 33) return 1.00;
        else return 0.00;
    }

    function calculateFinalResult() {
        const inputs = document.querySelectorAll('.input-mark');
        let totalObt = 0, totalFull = 0, totalGP = 0, failCount = 0;
        let marksArr = [];

        for(let inp of inputs) {
            if(inp.value === "") { alert("‡¶∏‡¶¨ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®!"); return; }
        }

        inputs.forEach(inp => {
            let m = parseFloat(inp.value);
            let f = parseFloat(inp.getAttribute('data-full'));
            marksArr.push(m);
            totalObt += m;
            totalFull += f;
            
            let p = (m/f)*100;
            totalGP += getGP(p);
            if(p < 33) failCount++;
        });

        let gpa = (totalGP / inputs.length).toFixed(2);
        if(gpa > 5) gpa = "5.00";
        let avg = (totalObt / inputs.length).toFixed(2);

        // Grade
        let grade = "";
        if(failCount > 0) grade = "F";
        else if(gpa == 5) grade = "A+";
        else if(gpa >= 4) grade = "A";
        else if(gpa >= 3.5) grade = "A-";
        else if(gpa >= 3) grade = "B";
        else if(gpa >= 2) grade = "C";
        else grade = "D";

        // Preview
        document.getElementById('r-total').innerText = totalObt;
        document.getElementById('r-gpa').innerText = gpa;
        document.getElementById('r-grade').innerText = grade;
        document.getElementById('result-area').style.display = 'block';

        // Add to list
        const student = {
            id: entrySerial++,
            total: totalObt,
            fullMark: totalFull,
            avg: avg,
            totalGP: totalGP.toFixed(2),
            gpa: parseFloat(gpa),
            grade: grade,
            isPass: failCount === 0,
            failCount: failCount,
            marks: marksArr
        };

        allStudents.push(student);
        calculateMeritPositions();
        renderTable();
        saveData();

        document.getElementById('merit-list-section').style.display = 'block';
        inputs.forEach(i => i.value = '');
    }

    // --- Merit Logic ---
    function calculateMeritPositions() {
        let sorted = [...allStudents].sort((a,b) => {
            if(a.isPass && !b.isPass) return -1;
            if(!a.isPass && b.isPass) return 1;
            if(a.isPass) return (b.gpa - a.gpa) || (b.total - a.total);
            return b.total - a.total; // Fail: High marks first
        });

        sorted.forEach((s, i) => {
            let orig = allStudents.find(x => x.id === s.id);
            orig.merit = i + 1;
        });
    }

    function renderTable() {
        const tbody = document.getElementById('student-rows');
        tbody.innerHTML = '';
        
        // Calculate Highest
        const maxScore = allStudents.length > 0 ? Math.max(...allStudents.map(s => s.total)) : 0;

        allStudents.forEach(s => {
            let rowClass = s.isPass ? "row-pass" : "row-fail";
            let status = s.isPass ? "Pass" : `Fail(${s.failCount})`;
            
            tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${s.id}</td>
                    <td>${s.total}</td>
                    <td>${s.avg}</td>
                    <td>${s.fullMark}</td>
                    <td>${maxScore}</td>
                    <td>${s.totalGP}</td>
                    <td>${s.gpa.toFixed(2)}</td>
                    <td>${s.grade}</td>
                    <td style="font-weight:bold;">${s.merit}</td>
                    <td>${status}</td>
                    <td class="action-col">
                        <button class="action-btn btn-edit" onclick="editStudent(${s.id})">‚úèÔ∏è</button>
                        <button class="action-btn btn-del" onclick="delStudent(${s.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- Storage & Utils ---
    function saveData() {
        localStorage.setItem('md_data', JSON.stringify(allStudents));
        localStorage.setItem('md_serial', entrySerial);
        localStorage.setItem('md_subs', JSON.stringify(selectedSubjects));
    }

    function loadData() {
        subjectsDB.forEach((s, i) => createSubjectCard(s.name, s.def, i<2?'checked':''));
        
        let savedSub = localStorage.getItem('md_subs');
        if(savedSub) {
            selectedSubjects = JSON.parse(savedSub);
            if(localStorage.getItem('md_data')) {
                allStudents = JSON.parse(localStorage.getItem('md_data'));
                entrySerial = parseInt(localStorage.getItem('md_serial'));
            }
            
            // Auto Skip to Step 2
            renderInputRows();
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            if(allStudents.length) {
                renderTable();
                document.getElementById('merit-list-section').style.display = 'block';
            }
        }
    }

    function clearAllData() {
        if(confirm("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!")) { localStorage.clear(); location.reload(); }
    }

    function delStudent(id) {
        if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
            allStudents = allStudents.filter(s => s.id !== id);
            calculateMeritPositions();
            renderTable();
            saveData();
        }
    }

    function editStudent(id) {
        let s = allStudents.find(x => x.id === id);
        if(confirm("‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®? (‡¶°‡¶æ‡¶ü‡¶æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)")) {
            let inputs = document.querySelectorAll('.input-mark');
            s.marks.forEach((m, i) => { if(inputs[i]) inputs[i].value = m; });
            delStudent(id); // Remove from list temporarily
            window.scrollTo({top:0, behavior:'smooth'});
            inputs[0].focus();
        }
    }
</script>

</body>
</html>
