<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ - ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 6px solid #00796b;
            padding-bottom: 20px;
        }

        /* Header */
        header {
            background-color: #e0f2f1;
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #b2dfdb;
        }
        header h1 { margin: 0; color: #00695c; font-size: 28px; }
        header p { margin: 5px 0 0; color: #555; }

        /* Steps */
        .step-container { padding: 25px; }
        .hidden { display: none; }

        h3 { border-left: 5px solid #00796b; padding-left: 10px; color: #333; }

        /* Step 1: Subject Selection */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .sub-card {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sub-card label { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .sub-card input[type="checkbox"] { transform: scale(1.3); accent-color: #00796b; }
        .fm-input { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }

        /* Step 2: Marks Input */
        .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .marks-table th { background: #00796b; color: white; padding: 10px; text-align: left; }
        .marks-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .input-mark { width: 90%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; display: block; }
        .input-mark:focus { border-color: #00796b; outline: none; background: #e0f2f1; }

        /* Buttons */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-size: 18px; cursor: pointer; font-weight: bold; color: white;
            transition: 0.3s; font-family: inherit;
        }
        .btn-next { background: #00796b; }
        .btn-calc { background: #d81b60; margin-bottom: 10px; }
        .btn-back { background: #546e7a; width: auto; padding: 8px 20px; font-size: 14px; margin-bottom: 10px; }
        .btn-add { background: #0288d1; width: auto; padding: 10px 20px; font-size: 14px; margin-bottom: 20px; }
        
        .btn-print { background: #455a64; margin-top: 15px; width: 48%; display: inline-block; }
        .btn-reset { background: #c62828; margin-top: 15px; width: 48%; display: inline-block; float: right; }
        
        .action-btn { padding: 5px 10px; font-size: 14px; margin: 2px; border-radius: 4px; border: none; cursor: pointer; color: white; }
        .btn-edit { background: #fbc02d; color: black; }
        .btn-del { background: #e53935; }

        /* Result Area */
        #result-area {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .res-box { background: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .res-box span { display: block; font-size: 14px; color: #666; }
        .res-box strong { display: block; font-size: 22px; color: #333; }
        
        .status-fail { color: #d32f2f; }
        .status-pass { color: #388e3c; }
        .full-width { grid-column: span 2; }

        /* Merit List Table */
        .list-table { width: 100%; border-collapse: collapse; margin-top: 10px; text-align: center; }
        .list-table th { background: #37474f; color: white; padding: 12px; border: 1px solid #37474f; }
        .list-table td { border: 1px solid #ddd; padding: 10px; font-size: 16px; }
        
        .row-pass { background-color: #fff; color: #333; }
        .row-fail { background-color: #ffebee; color: #c62828; } 

        /* PRINT STYLES */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .container { box-shadow: none; border: none; max-width: 100%; width: 100%; padding: 0; margin: 0; }
            .step-container, button, #result-area, .action-col { display: none !important; }
            
            /* Show only header and merit table */
            header { border-bottom: 2px solid #000; padding: 10px 0; }
            #merit-list-section { display: block !important; margin-top: 20px; }
            .list-table { width: 100%; font-size: 12px; }
            .list-table th, .list-table td { border: 1px solid #000; padding: 5px; color: black; }
            
            /* Ensure background colors print */
            .row-fail { background-color: #ffebee !important; -webkit-print-color-adjust: exact; }
            .row-pass { background-color: #fff !important; }
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
        <p>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡ßÄ ‡¶ì ‡¶Æ‡ßá‡¶ß‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
    </header>

    <div id="step1" class="step-container">
        <h3>‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ì ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">‡¶Ø‡ßá ‡¶¨‡¶ø‡¶∑‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®‡•§</p>
        
        <div class="subject-grid" id="subject-selection-area"></div>

        <button class="btn btn-add" onclick="addNewSubject()">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn btn-next" onclick="goToStep2()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™ (‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®) &raquo;</button>
        <br><br>
        <small style="color: blue;">* ‡¶Ö‡¶ü‡ßã ‡¶∏‡ßá‡¶≠ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶™‡ßá‡¶ú ‡¶ï‡¶æ‡¶ü‡¶≤‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶®‡ßá‡¶á‡•§</small>
    </div>

    <div id="step2" class="step-container hidden">
        <button class="btn btn-back" onclick="goBackToStep1()">&laquo; ‡¶¨‡¶ø‡¶∑‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        <h3>‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
        
        <table class="marks-table">
            <thead>
                <tr>
                    <th style="width: 50%">‡¶¨‡¶ø‡¶∑‡ßü</th>
                    <th style="width: 25%">‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</th>
                    <th style="width: 25%">‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                </tr>
            </thead>
            <tbody id="input-rows"></tbody>
        </table>

        <button class="btn btn-calc" onclick="calculateFinalResult()">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>

        <div id="result-area">
            <h4 style="text-align:center; margin:0 0 15px 0; color:#00796b;">‡¶∏‡¶¶‡ßç‡¶Ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h4>
            <div class="result-grid">
                <div class="res-box"><span>‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span><strong id="r-total-marks">0</strong></div>
                <div class="res-box"><span>‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</span><strong id="r-full-marks">0</strong></div>
                <div class="res-box"><span>‡¶ó‡ßú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span><strong id="r-avg">0</strong></div>
                <div class="res-box"><span>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶ø‡¶™‡¶ø</span><strong id="r-total-gp">0.00</strong></div>
                <div class="res-box full-width" style="background: #004d40; color: white;">
                    <span style="color: #b2dfdb;">‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§ ‡¶ú‡¶ø‡¶™‡¶ø‡¶è (GPA)</span>
                    <strong style="font-size: 36px; color: white;" id="r-gpa">0.00</strong>
                    <small id="r-grade" style="color: #ffeb3b; font-weight: bold;"></small>
                </div>
                <div class="res-box"><span>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</span><strong id="r-status">--</strong></div>
                <div class="res-box"><span>‡¶´‡ßá‡¶≤</span><strong id="r-fail-count" style="color: red;">0</strong> ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡ßá</div>
            </div>
        </div>

        <div id="merit-list-section" style="display: none; border-top: 2px dashed #bbb; margin-top: 30px; padding-top: 10px;">
            <h3 style="text-align: center; color: #37474f;">‡¶Æ‡ßá‡¶ß‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (Merit List)</h3>
            <table class="list-table">
                <thead>
                    <tr>
                        <th style="width: 10%">‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</th>
                        <th style="width: 20%">‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                        <th style="width: 20%">‡¶ú‡¶ø‡¶™‡¶ø‡¶è (GPA)</th>
                        <th style="width: 15%">‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü</th>
                        <th class="action-col" style="width: 25%">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                    </tr>
                </thead>
                <tbody id="student-rows">
                    </tbody>
            </table>

            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn btn-reset" onclick="clearAllData()">üóëÔ∏è ‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
        </div>

    </div>
</div>

<script>
    // Global Data
    let allStudents = [];
    let entrySerial = 1;
    let selectedSubjects = [];

    // Default DB
    const subjectsDB = [
        { id: 'quran', name: '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶Æ‡¶æ‡¶ú‡¶ø‡¶¶', def: 100 },
        { id: 'akaid', name: '‡¶Ü‡¶ï‡¶æ‡¶á‡¶¶ ‡¶ì ‡¶´‡¶ø‡¶ï‡¶π', def: 100 },
        { id: 'hadith', name: '‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶∂‡¶∞‡ßÄ‡¶´', def: 100 },
        { id: 'arb1', name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'arb2', name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'ban1', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'ban2', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'eng1', name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'eng2', name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', def: 100 },
        { id: 'math', name: '‡¶ó‡¶£‡¶ø‡¶§', def: 100 },
        { id: 'bgs', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶™‡¶∞‡¶ø‡¶ö‡ßü', def: 100 },
        { id: 'sci', name: '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', def: 100 },
        { id: 'agri', name: '‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', def: 100 },
        { id: 'ict', name: '‡¶§‡¶•‡ßç‡¶Ø ‡¶ì ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø', def: 50 }
    ];

    // --- INITIALIZATION & LOCAL STORAGE ---
    window.onload = function() {
        loadData();
    };

    function saveData() {
        localStorage.setItem('madrasah_students', JSON.stringify(allStudents));
        localStorage.setItem('madrasah_serial', entrySerial);
        localStorage.setItem('madrasah_subjects', JSON.stringify(selectedSubjects));
    }

    function loadData() {
        // Load Subjects Check
        const savedSub = localStorage.getItem('madrasah_subjects');
        const container = document.getElementById('subject-selection-area');
        
        // Render Default Subject List
        subjectsDB.forEach((sub, index) => {
            const isChecked = index < 2 ? 'checked' : ''; 
            createSubjectCard(sub.name, sub.def, isChecked);
        });

        // If saved data exists, skip to step 2
        if(savedSub) {
            selectedSubjects = JSON.parse(savedSub);
            if(selectedSubjects.length > 0) {
                // Restore Serial and Students
                if(localStorage.getItem('madrasah_students')) {
                    allStudents = JSON.parse(localStorage.getItem('madrasah_students'));
                    entrySerial = parseInt(localStorage.getItem('madrasah_serial')) || 1;
                }
                
                // Go to step 2 directly
                renderInputRows();
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                
                // Recalculate and Render Table
                if(allStudents.length > 0) {
                    calculateMeritPositions();
                    renderStudentTable();
                    document.getElementById('merit-list-section').style.display = 'block';
                }
            }
        }
    }

    function clearAllData() {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- DOM FUNCTIONS ---
    function createSubjectCard(name, fullMark, checkedAttr) {
        const container = document.getElementById('subject-selection-area');
        const div = document.createElement('div');
        div.className = 'sub-card';
        div.innerHTML = `
            <label>
                <input type="checkbox" class="sub-check" data-name="${name}" ${checkedAttr}>
                ${name}
            </label>
            <input type="number" class="fm-input" value="${fullMark}" placeholder="Full">
        `;
        container.appendChild(div);
    }

    function addNewSubject() {
        let name = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        if (name && name.trim() !== "") {
            createSubjectCard(name, 100, 'checked');
        }
    }

    function goToStep2() {
        selectedSubjects = [];
        const cards = document.querySelectorAll('.sub-card');
        
        cards.forEach(card => {
            const checkbox = card.querySelector('.sub-check');
            const fullMark = card.querySelector('.fm-input').value;
            
            if(checkbox.checked) {
                selectedSubjects.push({
                    name: checkbox.getAttribute('data-name'),
                    full: parseInt(fullMark) || 100
                });
            }
        });

        if(selectedSubjects.length === 0) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            return;
        }

        saveData(); // Save selection
        renderInputRows();
        
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        
        setTimeout(() => {
            const inputs = document.querySelectorAll('.input-mark');
            if(inputs.length > 0) inputs[0].focus();
        }, 100);
    }

    function goBackToStep1() {
        if(confirm("‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßá‡¶∂‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            localStorage.removeItem('madrasah_subjects'); // Clear session sub
            location.reload();
        }
    }

    function renderInputRows() {
        const tbody = document.getElementById('input-rows');
        tbody.innerHTML = '';
        selectedSubjects.forEach((sub, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${sub.name}</td>
                <td style="text-align:center; font-weight:bold; color:#666;">${sub.full}</td>
                <td>
                    <input type="number" class="input-mark" data-full="${sub.full}" placeholder="Mark" oninput="handleInput(this, ${index})">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function handleInput(input, index) {
        let val = input.value;
        const fullMark = parseFloat(input.getAttribute('data-full'));
        const allInputs = document.querySelectorAll('.input-mark');

        if (val !== "" && parseFloat(val) > fullMark) {
            alert(`‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§! ‡¶è‡¶á ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶® ${fullMark}‡•§`);
            input.value = ""; 
            return;
        }
        if (val.length >= 2 && val !== "10") { 
            if (index + 1 < allInputs.length) {
                setTimeout(() => allInputs[index + 1].focus(), 100); 
            }
        }
    }

    function getGP(percentage) {
        if (percentage >= 80) return 5.00;
        else if (percentage >= 70) return 4.00;
        else if (percentage >= 60) return 3.50;
        else if (percentage >= 50) return 3.00;
        else if (percentage >= 40) return 2.00;
        else if (percentage >= 33) return 1.00;
        else return 0.00;
    }

    // --- MAIN CALCULATION LOGIC ---
    function calculateFinalResult() {
        const inputs = document.querySelectorAll('.input-mark');
        let totalObtained = 0;
        let totalFullMarks = 0;
        let totalGP = 0;
        let failCount = 0;
        let subjectCount = inputs.length;
        
        // Store marks for edit feature
        let marksArray = [];

        for(let inp of inputs) {
            if(inp.value === "") {
                alert("‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }
        }

        inputs.forEach(inp => {
            let marks = parseFloat(inp.value);
            let full = parseFloat(inp.getAttribute('data-full'));
            marksArray.push(marks); // Save raw marks
            
            totalObtained += marks;
            totalFullMarks += full;

            let percent = (marks / full) * 100;
            let gp = getGP(percent);
            totalGP += gp;
            if(percent < 33) failCount++;
        });

        let finalGPA = (totalGP / subjectCount).toFixed(2);
        let avgMarks = (totalObtained / subjectCount).toFixed(2);
        if(finalGPA > 5.00) finalGPA = "5.00";

        // Display Current Result
        document.getElementById('r-gpa').innerText = finalGPA;
        document.getElementById('r-total-marks').innerText = totalObtained;
        document.getElementById('r-full-marks').innerText = totalFullMarks;
        document.getElementById('r-avg').innerText = avgMarks;
        document.getElementById('r-total-gp').innerText = totalGP.toFixed(2);
        
        let letter = "";
        if(finalGPA == 5.00) letter = "(A+)";
        else if(finalGPA >= 4.00) letter = "(A)";
        else if(finalGPA >= 3.50) letter = "(A-)";
        else if(finalGPA >= 3.00) letter = "(B)";
        else if(finalGPA >= 2.00) letter = "(C)";
        else letter = "(D)";
        if(finalGPA < 1.00) letter = "(F)";
        document.getElementById('r-grade').innerText = letter;

        const statusElem = document.getElementById('r-status');
        if(failCount > 0) {
            statusElem.innerText = "‡¶Ö‡¶ï‡ßÉ‡¶§‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø";
            statusElem.className = "status-fail";
            document.getElementById('r-fail-count').innerText = failCount;
        } else {
            statusElem.innerText = "‡¶ï‡ßÉ‡¶§‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø";
            statusElem.className = "status-pass";
            document.getElementById('r-fail-count').innerText = "0";
        }
        
        document.getElementById('result-area').style.display = 'block';
        
        // --- ADD TO LIST ---
        let isPass = failCount === 0;
        const newStudent = {
            id: entrySerial,
            total: totalObtained,
            gpa: parseFloat(finalGPA),
            isPass: isPass,
            merit: 0,
            rawMarks: marksArray // Save marks for editing
        };

        allStudents.push(newStudent);
        entrySerial++;

        calculateMeritPositions();
        renderStudentTable();
        saveData(); // Save to local storage

        document.getElementById('merit-list-section').style.display = 'block';

        // Auto Clear Inputs
        inputs.forEach(inp => inp.value = '');
    }

    function calculateMeritPositions() {
        let sortedList = [...allStudents];
        sortedList.sort((a, b) => {
            if (a.isPass && !b.isPass) return -1;
            if (!a.isPass && b.isPass) return 1;
            if (a.isPass && b.isPass) {
                if (b.gpa !== a.gpa) return b.gpa - a.gpa;
                return b.total - a.total;
            }
            if (!a.isPass && !b.isPass) return b.total - a.total;
        });

        sortedList.forEach((student, index) => {
            const originalStudent = allStudents.find(s => s.id === student.id);
            originalStudent.merit = index + 1;
        });
    }

    function renderStudentTable() {
        const tbody = document.getElementById('student-rows');
        tbody.innerHTML = '';
        allStudents.forEach(student => {
            let rowClass = student.isPass ? "row-pass" : "row-fail";
            let gpaDisplay = student.gpa.toFixed(2); 

            const row = `
                <tr class="${rowClass}">
                    <td>${student.id}</td>
                    <td>${student.total}</td>
                    <td>${gpaDisplay}</td>
                    <td style="font-weight:bold;">${student.merit}</td>
                    <td class="action-col">
                        <button class="action-btn btn-edit" onclick="editStudent(${student.id})">‚úèÔ∏è</button>
                        <button class="action-btn btn-del" onclick="deleteStudent(${student.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- ACTIONS: EDIT & DELETE ---
    function deleteStudent(id) {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            allStudents = allStudents.filter(s => s.id !== id);
            calculateMeritPositions();
            renderStudentTable();
            saveData();
        }
    }

    function editStudent(id) {
        const student = allStudents.find(s => s.id === id);
        if(!student) return;

        if(confirm(`‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ${student.id} ‡¶è‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶è‡¶ü‡¶ø ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)`)) {
            // Load marks back to inputs
            const inputs = document.querySelectorAll('.input-mark');
            if(student.rawMarks && student.rawMarks.length === inputs.length) {
                inputs.forEach((inp, idx) => {
                    inp.value = student.rawMarks[idx];
                });
                
                // Remove from list
                deleteStudent(id); 
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                inputs[0].focus();
            } else {
                alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ)‡•§");
            }
        }
    }
</script>

</body>
</html>
