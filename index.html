<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abdur Razzaq Dakhil Madrasah - Result System</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@300;400;500;600;700&display=swap');
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --brand:#0f766e;
      --brand2:#064e3b;
      --accent:#2563eb;
      --warn:#f59e0b;
      --danger:#dc2626;
      --ok:#16a34a;
      --line:#e5e7eb;
      --shadow: 0 12px 35px rgba(17,24,39,.10);
      --shadow2: 0 8px 20px rgba(17,24,39,.08);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      font-family:'Hind Siliguri','Noto Serif Bengali', sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(15,118,110,.10), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(37,99,235,.10), transparent 55%),
        var(--bg);
      margin:0;
      padding:18px;
      color:var(--text);
    }

    .wrap{max-width: 980px; margin: 0 auto;}

    /* Top Hero Header */
    .hero{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-radius: 22px;
      padding: 22px 18px;
      color:#fff;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-60px -80px auto auto;
      width:260px;
      height:260px;
      background: radial-gradient(circle, rgba(255,255,255,.22), transparent 60%);
      transform: rotate(20deg);
      filter: blur(2px);
    }
    .hero-top{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .hero h1{ margin:0; font-size: 28px; line-height:1.15; letter-spacing:.2px; }
    .hero p{ margin:6px 0 0; opacity:.92; font-size: 14px; }
    .hero-right{ text-align:right; min-width: 220px; }
    .hero-right small{ display:block; opacity:.9; font-size: 12px; }

    /* App Card */
    .card{
      margin-top: 14px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      border: 1px solid rgba(229,231,235,.85);
      overflow:hidden;
    }
    .card-head{
      padding: 16px 18px;
      background: linear-gradient(180deg, rgba(15,118,110,.06), rgba(15,118,110,0));
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .steps{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .step-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:700;
      font-size: 13px;
    }
    .step-pill.active{
      border-color: rgba(15,118,110,.35);
      background: rgba(15,118,110,.08);
      color: var(--brand2);
    }
    .step-pill .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--line);
    }
    .step-pill.active .dot{
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(15,118,110,.12);
    }
    .autosave{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .autosave b{color: var(--brand2)}
    .autosave .pulse{
      width:10px;height:10px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 0 rgba(22,163,74,.30);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(22,163,74,.30)}
      70%{box-shadow:0 0 0 10px rgba(22,163,74,0)}
      100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}
    }

    .card-body{ padding: 18px; }
    .hidden{ display:none; }

    h3{
      margin:0 0 10px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hbar{
      width:10px;height:22px;border-radius: 6px;
      background: linear-gradient(180deg, var(--brand), var(--accent));
    }
    .subtext{
      margin:0 0 14px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Subject selection cards */
    .subject-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .sub-card{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(15,118,110,.06), rgba(255,255,255,0));
      transition: .18s ease;
    }
    .sub-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
      border-color: rgba(15,118,110,.22);
    }
    .sub-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .sub-label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 700;
      color: #0b1220;
      cursor:pointer;
      user-select:none;
    }
    .sub-label input{
      transform: scale(1.25);
      accent-color: var(--brand);
      cursor:pointer;
    }
    .fm-wrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      min-width: 86px;
    }
    .fm-input{
      width: 86px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-weight: 700;
      text-align: center;
      outline:none;
      background:#fff;
      transition:.15s;
    }
    .fm-input:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    /* toggles */
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.08);
      border-radius: 999px;
      margin-top: 14px;
    }
    .toggle input{
      transform: scale(1.25);
      accent-color: var(--warn);
      cursor:pointer;
      margin: 0;
    }
    .toggle label{
      cursor:pointer;
      font-weight: 700;
      color:#7c2d12;
      font-size: 13px;
      line-height: 1.25;
    }

    /* Buttons */
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .btn{
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 800;
      cursor:pointer;
      color:#fff;
      transition:.18s ease;
      box-shadow: 0 10px 22px rgba(17,24,39,.10);
    }
    .btn:active{ transform: scale(.99); }
    .btn:hover{ transform: translateY(-1px); }

    .btn-primary{ background: linear-gradient(135deg, var(--brand), var(--brand2)); }
    .btn-accent{ background: linear-gradient(135deg, #db2777, #9d174d); }
    .btn-muted{ background: linear-gradient(135deg, #64748b, #334155); }
    .btn-add{ background: linear-gradient(135deg, #0284c7, #1d4ed8); }
    .btn-warn{ background: linear-gradient(135deg, #f59e0b, #d97706); color:#111827; }
    .btn-danger{ background: linear-gradient(135deg, #ef4444, #b91c1c); }
    .btn-small{ padding: 9px 12px; border-radius: 10px; font-size: 14px; box-shadow:none; }
    .btn-info { background: linear-gradient(135deg, #06b6d4, #0891b2); color: #fff; }

    /* Marks table */
    .marks-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .marks-table th{
      background: linear-gradient(135deg, rgba(15,118,110,.14), rgba(37,99,235,.10));
      color:#0b1220;
      text-align:left;
      font-weight: 900;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
    }
    .marks-table td{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: middle;
      font-size: 15px;
    }
    .marks-table tr:last-child td{ border-bottom:none; }
    .input-mark{
      width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 800;
      outline:none;
      transition:.15s;
      background:#fff;
    }
    .input-mark:focus{
      border-color: rgba(15,118,110,.45);
      box-shadow: 0 0 0 4px rgba(15,118,110,.12);
      background: rgba(15,118,110,.04);
    }

    /* Edit banner */
    #edit-message{
      display:none;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      color:#7c2d12;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      margin: 12px 0 14px;
    }

    /* Result card */
    #result-area{
      display:none;
      margin-top: 14px;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(22,163,74,.22);
      background: linear-gradient(180deg, rgba(22,163,74,.07), rgba(255,255,255,.0));
    }
    .result-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .res-box{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      text-align:center;
      box-shadow: 0 8px 20px rgba(17,24,39,.06);
    }
    .res-box span{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
    }
    .res-box strong{
      display:block;
      font-size: 22px;
      font-weight: 900;
      margin-top: 4px;
    }
    .full-width{ grid-column: span 2; }
    .gpa-box{
      background: linear-gradient(135deg, var(--brand2), var(--brand));
      color:#fff;
      border: none;
      position:relative;
      overflow:hidden;
    }
    .gpa-box::after{
      content:"";
      position:absolute;
      inset:-60px -70px auto auto;
      width:220px;height:220px;
      background: radial-gradient(circle, rgba(255,255,255,.18), transparent 62%);
      transform: rotate(10deg);
    }
    .gpa-box span{ color: rgba(255,255,255,.85); }
    .gpa-box strong{ font-size: 42px; color:#fff; }
    #r-grade{ display:block; margin-top: 6px; font-weight: 900; color:#fde047; font-size: 16px; }

    .status-pass{ color: var(--ok); }
    .status-fail{ color: var(--danger); }

    /* Merit table section */
    #merit-list-section{
      display:none;
      margin-top: 18px;
      border-top: 1px dashed rgba(107,114,128,.45);
      padding-top: 14px;
    }
    .section-title{
      text-align:center;
      margin:0 0 10px;
      color:#0b1220;
      font-size: 18px;
      font-weight: 1000;
    }
    .table-responsive{
      overflow:auto;
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
    }
    .list-table{
      width:100%;
      border-collapse: collapse;
      text-align:center;
      min-width: 900px;
    }
    .list-table th{
      position: sticky;
      top: 0;
      z-index: 1;
      background: #0b1220;
      color:#fff;
      padding: 10px 10px;
      font-size: 13px;
      border: 1px solid #0b1220;
      white-space: nowrap;
    }
    .list-table td{
      border: 1px solid var(--line);
      padding: 10px 8px;
      font-size: 15px;
      white-space: nowrap;
      background:#fff;
    }
    .row-fail td{ background: rgba(220,38,38,.08); color:#7f1d1d; font-weight: 800; }
    .row-pass td{ color:#111827; }
    .hl{ font-weight: 1000; }

    .btn-edit{
      border:none;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 1000;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color:#111827;
      transition:.15s;
    }
    .btn-edit:hover{ transform: translateY(-1px); }

    .footer{ margin-top: 14px; text-align:center; color: var(--muted); font-size: 13px; }
    .footer a{ color: var(--brand); text-decoration:none; font-weight: 900; }

    /* PRINT STYLES FIXED */
    @media print{
      @page { margin: 10mm; }
      body{ background:#fff; padding:0mm;  }
      body *{ visibility:hidden; }

      /* Normal Print (List) */
      #print-area, #print-area *{ visibility: visible; }
      #print-area{ position:absolute; left:0; top:0; width:100%; }

      /* Overwrite for Individual Print Mode */
      body.print-mode-individual #print-area { display: none !important; }
      
      body.print-mode-individual #individual-print-container { 
        visibility: visible !important; 
        display: block !important;
        position: absolute; 
        left: 0; 
        top: 0; 
        width: 100%; 
      }
      body.print-mode-individual #individual-print-container * { visibility: visible !important; }

      /* General Print Resets */
      .no-print, .action-col, .btn-edit, .api-control-box, .student-info-display { display:none !important; }
      .section-title{ display:none !important; }
      
      /* List Table Print Specifics */
      #merit-list-section{
        display:none;
        margin-top: 0px;
        border-top: 0px dashed rgba(107,114,128,.45);
        padding-top: 0px;
      }
      .print-head{
        display:block !important;
        text-align:center;
        padding: 0px 0 0px;
        border-bottom: 0px solid #000;
        margin-bottom: 10px;
      }
      .print-head h1{ margin:0; font-size: 20px; }
      .print-head h2{ margin:4px 0 0; font-size: 14px; font-weight: 800; }
      .print-head p{ margin:2px 0 0; font-size: 12px; }

      .table-responsive{ border:none; border-radius: 0; }
      .list-table{ min-width: 0 !important; width: 100% !important; font-size: 12px; border-collapse: collapse; }
      .list-table th, .list-table td{ border: 1px solid #000 !important; color:#000 !important; }
      .list-table td{ padding: 2px 3px !important; }
      .list-table th{
        background: #eee !important;
        padding: 0 !important;
        height: 105px;
        vertical-align: bottom;
      }
      .row-pass td{ font-weight: normal !important ;}
      .row-fail td{
        font-weight: normal !important ;
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .list-table th span{
        display:block;
        transform: rotate(-90deg);
        width: 26px;
        margin: 0 auto 6px;
        font-weight: 900;
        font-size: 12px;
      }

      /* Individual Marksheet Style - FIXED BREAKS */
      .print-page {
          display: block;
          page-break-after: always;
          break-after: page;
          width: 100%;
          min-height: 95vh;
          padding: 30px;
          border: 2px solid #000;
          box-sizing: border-box;
          position: relative;
          margin-bottom: 20px;
      }
      .print-page:last-child { page-break-after: auto; break-after: auto; }
      
      .sheet-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
      .sheet-header h1 { margin: 0; font-size: 26px; color: #000; }
      .sheet-header p { margin: 4px 0; font-size: 14px; }
      .exam-title-print { font-size: 18px; font-weight: 800; margin-top: 8px; border: 1px solid #000; display: inline-block; padding: 4px 15px; border-radius: 20px; }
      
      .student-info-box {
          display: flex; justify-content: space-between; margin-bottom: 20px; border: 1px solid #000; padding: 10px; font-size: 14px;
      }
      .student-info-col div { margin-bottom: 4px; }

      .sheet-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
      .sheet-table th, .sheet-table td { border: 1px solid #000; padding: 6px 8px; text-align: center; color: #000; }
      .sheet-table th { background: #eee !important; font-weight: 800; }
      .sheet-table td:first-child { text-align: left; font-weight: 700; }

      .summary-box { border: 1px solid #000; padding: 10px; margin-bottom: 40px; }
      .sum-row { display: flex; justify-content: space-around; font-weight: 800; font-size: 16px; }
      
      .footer-sign { display: flex; justify-content: space-between; margin-top: 60px; font-size: 12px; }
      .sign-line { border-top: 1px solid #000; width: 150px; text-align: center; padding-top: 5px; }
    }

    /* Toast (Alert Alternative) */
    .toast {
      position: fixed;
      left: 50%;
      top: 14px;
      transform: translateX(-50%) translateY(-8px);
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 14px 35px rgba(0,0,0,0.25);
      font-size: 14px;
      line-height: 1.35;
      max-width: 92vw;
      width: min(520px, 92vw);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.16);
      overflow: hidden;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .toast-content{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .toast-icon{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      flex: 0 0 auto;
      margin-top: 1px;
      background: rgba(255,255,255,0.14);
    }
    .toast-text{
      flex: 1 1 auto;
      font-weight: 700;
      letter-spacing: .1px;
    }
    .toast.warn { background: rgba(245, 158, 11, 0.92); color: #111827; border-color: rgba(17,24,39,0.08); }
    .toast.warn .toast-icon{ background: rgba(17,24,39,0.12); }
    .toast.danger { background: rgba(239, 68, 68, 0.92); color: #fff; border-color: rgba(255,255,255,0.18); }
    .toast.success { background: rgba(5, 150, 105, 0.92); }

    /* Floating Focus Button (Premium) */
    .fab-focus{
      position:fixed;
      right:18px;
      bottom:18px;
      width:45px;
      height:45px;
      border-radius:999px;
      background: radial-gradient(120% 120% at 30% 20%, #10b981 0%, #00796b 40%, #004d40 100%);
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      box-shadow: 0 16px 35px rgba(0,0,0,.30);
      cursor:pointer;
      z-index:9999;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      overflow:hidden;
      transform: translateZ(0);
      font-weight: 1000;
      font-size: 24px;
      line-height: 1;
    }
    .fab-focus.show{
      display:flex;
      animation: fabFloat 2.8s ease-in-out infinite;
    }
    @keyframes fabFloat{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-4px); }
    }
    .fab-focus::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius:999px;
      border: 2px solid rgba(16,185,129,.0);
      opacity:0;
    }
    .fab-focus.show::after{ animation: fabGlow 2.8s ease-in-out infinite; }
    @keyframes fabGlow{
      0%,100%{ opacity:.0; border-color: rgba(16,185,129,.0); }
      50%{ opacity:.35; border-color: rgba(16,185,129,.55); }
    }
    .fab-focus:active{
      transform: scale(.96);
      animation: none;
    }
    .fab-focus:active::before{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      width:10px;
      height:10px;
      border-radius:999px;
      transform: translate(-50%,-50%);
      background: rgba(255,255,255,.55);
      animation: fabRipple .45s ease-out forwards;
    }
    @keyframes fabRipple{
      to{ width:140px; height:140px; opacity:0; }
    }

    /* API Controls Style */
    .api-control-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        padding: 14px;
        border-radius: 14px;
        margin-bottom: 16px;
    }
    .api-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    .api-select {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        flex: 1;
        font-weight: 700;
        outline: none;
    }
    .student-info-display {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
        padding: 14px;
        border-radius: 14px;
        font-size: 16px;
        margin-bottom: 14px;
        font-weight: 700;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-left: 5px solid #16a34a;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="hero-top">
        <div>
          <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
          <p>‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</p>
        </div>
        <div class="hero-right">
          <small>Developed by</small>
          <div style="font-weight:1000;font-size:15px;">Raisul Islam Saied</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="steps">
          <div class="step-pill active" id="pill1"><span class="dot"></span> ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶¨‡¶ø‡¶∑‡ßü</div>
          <div class="step-pill" id="pill2"><span class="dot"></span> ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div>
        </div>
        <div class="autosave"><span class="pulse"></span> <b>Auto Save</b> ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá</div>
      </div>

      <div class="card-body">

        <!-- STEP 1 -->
        <div id="step1">
          <!-- API FETCH SECTION -->
          <div class="api-control-box">
             <h4 style="margin:0 0 10px; color:#1e40af; display:flex; align-items:center; gap:6px;">
                 üåê Student Information Fetching
             </h4>
             <div class="api-row">
                 <select id="api-class" class="api-select">
                     <option value="">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®...</option>
                     <option value="‡¶™‡ßç‡¶≤‡ßá">‡¶™‡ßç‡¶≤‡ßá (Play)</option>
                     <option value="‡¶®‡¶æ‡¶∞‡ßç‡¶∏‡¶æ‡¶∞‡¶ø">‡¶®‡¶æ‡¶∞‡ßç‡¶∏‡¶æ‡¶∞‡¶ø (Nursery)</option>
                     <option value="‡¶ï‡ßá‡¶ú‡¶ø">‡¶ï‡ßá‡¶ú‡¶ø (KG)</option>
                     <option value="‡ßß‡¶Æ">‡ßß‡¶Æ (One)</option>
                     <option value="‡ß®‡ßü">‡ß®‡ßü (Two)</option>
                     <option value="‡ß©‡ßü">‡ß©‡ßü (Three)</option>
                     <option value="‡ß™‡¶∞‡ßç‡¶•">‡ß™‡¶∞‡ßç‡¶• (Four)</option>
                     <option value="‡ß´‡¶Æ">‡ß´‡¶Æ (Five)</option>
                     <option value="‡ß¨‡¶∑‡ßç‡¶†">‡ß¨‡¶∑‡ßç‡¶† (Six)</option>
                     <option value="‡ß≠‡¶Æ">‡ß≠‡¶Æ (Seven)</option>
                     <option value="‡ßÆ‡¶Æ">‡ßÆ‡¶Æ (Eight)</option>
                     <option value="‡ßØ‡¶Æ">‡ßØ‡¶Æ (Nine)</option>
                     <option value="‡ßß‡ß¶‡¶Æ">‡ßß‡ß¶‡¶Æ (Ten)</option>
                 </select>
                 <select id="api-year" class="api-select">
                     <option value="2024">2024</option>
                     <option value="2025" selected>2025</option>
                     <option value="2026">2026</option>
                 </select>
                 <button class="btn btn-add btn-small" id="btn-fetch" onclick="fetchOnlineStudents()">
                     Online ‡¶•‡ßá‡¶ï‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                 </button>
             </div>
          </div>

          <h3><span class="hbar"></span> ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</h3>
          <p class="subtext">
            ‡¶Ø‡ßá ‡¶¨‡¶ø‡¶∑‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®‡•§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶¨‡¶æ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
          </p>

          <div class="subject-grid" id="subject-selection-area"></div>

          <div class="btnrow">
            <button class="btn btn-add" onclick="addNewSubject()">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </div>
<div class="btnrow">
<label class="btn btn-add btn-small">
  üìÇ CSV ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
  <input type="file" accept=".csv" onchange="handleCSVUpload(event)" hidden>
</label>

</div>
          <div class="toggle">
            <input type="checkbox" id="decimal-toggle" onchange="toggleDecimal()">
            <label for="decimal-toggle">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï ‡¶π‡¶≤‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®: ‡ßÆ‡ß¶.‡ß´‡ß¶) ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®</label>
          </div>

          <div class="toggle" style="margin-top:10px;">
            <input type="checkbox" id="auto-result-toggle" checked onchange="toggleAutoResult()">
            <label for="auto-result-toggle">‡¶∂‡ßá‡¶∑ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá</label>
          </div>

          <div class="btnrow">
            <button class="btn btn-primary" onclick="goToStep2()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™ (‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®) &raquo;</button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" class="hidden">
          <div class="btnrow no-print" style="margin-top:0">
            <button class="btn btn-muted btn-small" onclick="goBackToStep1()">&laquo; ‡¶¨‡¶ø‡¶∑‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </div>

          <h3 style="margin-top:6px;"><span class="hbar"></span> ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>

          <!-- AUTOMATIC INFO DISPLAY -->
          <div id="active-student-info" class="student-info-display"></div>
          
          <!-- Hidden Edit Message (We reuse the main display for better look) -->
          <p id="edit-message" style="display:none"></p>

          <table class="marks-table">
            <thead>
              <tr>
                <th style="width: 48%">‡¶¨‡¶ø‡¶∑‡ßü</th>
                <th style="width: 20%; text-align:center;">‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</th>
                <th style="width: 32%">‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
              </tr>
            </thead>
            <tbody id="input-rows"></tbody>
          </table>

          <div class="btnrow no-print">
            <button id="calculate-btn" class="btn btn-accent" onclick="calculateFinalResult()">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
          </div>

          <div id="result-area">
            <h4 style="text-align:center;margin:0 0 12px;font-weight:1000;color:var(--brand2);">
              ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡ßÄ
            </h4>

            <div class="result-grid">
              <div class="res-box">
                <span>‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span>
                <strong id="r-total-marks">0</strong>
              </div>
              <div class="res-box">
                <span>‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</span>
                <strong id="r-full-marks">0</strong>
              </div>
              <div class="res-box">
                <span>‡¶ó‡ßú ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (%)</span>
                <strong id="r-avg">0</strong>
              </div>
              <div class="res-box">
                <span>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶ø‡¶™‡¶ø (GP)</span>
                <strong id="r-total-gp">0.00</strong>
              </div>

              <div class="res-box gpa-box full-width">
                <span>‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§ ‡¶ú‡¶ø‡¶™‡¶ø‡¶è (GPA)</span>
                <strong id="r-gpa">0.00</strong>
                <small id="r-grade"></small>
              </div>

              <div class="res-box">
                <span>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</span>
                <strong id="r-status">--</strong>
              </div>
              <div class="res-box">
                <span>‡¶´‡ßá‡¶≤ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®</span>
                <strong id="r-fail-count" style="color:var(--danger);">0</strong> ‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü‡ßá
              </div>
            </div>
          </div>

          <!-- PRINT AREA (MERIT LIST) -->
          <div id="print-area">
            <div class="print-head" style="display:none">
              <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
              <h2>‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
              <p>Result Sheet (Auto Generated)</p>
            </div>

            <div id="merit-list-section">
              <div class="section-title">‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>

              <div class="table-responsive">
                <table class="list-table" id="final-table">
                  <thead>
                    <tr id="table-headers"></tr>
                  </thead>
                  <tbody id="student-rows"></tbody>
                </table>
              </div>

              <div class="btnrow no-print" style="margin-top:12px;">
                <button class="btn btn-primary" style="flex:1" onclick="downloadExcel()">üì• Excel ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-add" style="flex:1" onclick="printResultList()"
">üñ®Ô∏è PDF / ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü (‡¶≤‡¶ø‡¶∏‡ßç‡¶ü)</button>
              </div>

              <!-- NEW BUTTON FOR INDIVIDUAL MARK SHEET -->
              <div class="btnrow no-print" style="margin-top:12px;">
                 <button class="btn btn-info" style="width:100%; font-weight:1000;" onclick="printAllIndividualResults()">üìÑ ‡¶∏‡¶¨ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶∂‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (A4)</button>
              </div>

              <div class="btnrow no-print">
                <button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® (Reset)</button>
              </div>
            </div>
          </div>
          
          <!-- HIDDEN CONTAINER FOR INDIVIDUAL RESULTS -->
          <div id="individual-print-container" style="display:none;"></div>

        </div>

      </div>
    </div>

    <div class="footer">
      Developed by <a href="https://www.facebook.com/raisulislamsaied" target="_blank" rel="noreferrer">Raisul Islam Saied</a>
    </div>
  </div>

  <!-- Toast + Floating Button (must be outside Excel export) -->
  <div id="toast" class="toast" aria-live="polite"></div>
  <div id="fabFocus" class="fab-focus" title="‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá ‡¶Ø‡¶æ‡¶®" onclick="focusFirstMarkInput()">+</div>

<script>
  // Global Storage
  let allStudents = [];
  let entrySerial = 1;
  let selectedSubjects = [];
  let isDecimalEnabled = false;
  let editModeId = null;

  // API NEW GLOBALS
  let fetchedStudents = [];
  let currentGradingStudent = null; // Store selected student object
  let csvMode = false;
  const API_URL = "https://script.google.com/macros/s/AKfycbwJdYyKraaP194D-byPE8zZnCtIRyRgJRIN-AoH4CT5N7joPY_D63ZgfgwpdzJbEea0kA/exec";

  // Toast helper (replaces alert)
  let toastTimer = null;
  function showToast(message, type='danger', ms=1700){
    const t = document.getElementById('toast');
    if(!t) return;

    const icon = (type==='success') ? '‚úì' : (type==='warn' ? '!' : '√ó');
    t.className = 'toast ' + (type || 'danger');

    t.innerHTML = `
      <div class="toast-content">
        <div class="toast-icon" aria-hidden="true">${icon}</div>
        <div class="toast-text">${message}</div>
      </div>
    `;

    t.onclick = () => t.classList.remove('show');

    requestAnimationFrame(() => t.classList.add('show'));

    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      t.classList.remove('show');
    }, ms);
  }

  let autoResultEnabled = true; // auto result on last input

  const subjectsDB = [
    { name: '‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶Æ‡¶æ‡¶ú‡¶ø‡¶¶', short: 'Quran', def: 100 },
    { name: '‡¶Ü‡¶ï‡¶æ‡¶á‡¶¶ ‡¶ì ‡¶´‡¶ø‡¶ï‡¶π', short: 'Aqaid', def: 100 },
    { name: '‡¶π‡¶æ‡¶¶‡¶ø‡¶∏ ‡¶∂‡¶∞‡ßÄ‡¶´', short: 'Hadith', def: 100 },
    { name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', short: 'Arabic 1st', def: 100 },
    { name: '‡¶Ü‡¶∞‡¶¨‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', short: 'Arabic 2nd', def: 100 },
    { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', short: 'Bangla 1st', def: 100 },
    { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', short: 'Bangla 2nd', def: 100 },
    { name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ßß‡¶Æ ‡¶™‡¶§‡ßç‡¶∞', short: 'English 1st', def: 100 },
    { name: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡ß®‡ßü ‡¶™‡¶§‡ßç‡¶∞', short: 'English 2nd', def: 100 },
    { name: '‡¶ó‡¶£‡¶ø‡¶§', short: 'Math', def: 100 },
    { name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶™‡¶∞‡¶ø‡¶ö‡ßü', short: 'BGS', def: 100 },
    { name: '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', short: 'Science', def: 100 },
    { name: '‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', short: 'Agri', def: 100 },
    { name: '‡¶Æ‡¶æ‡¶®‡¶§‡¶ø‡¶ï', short: 'Mantiq', def: 100 },
    { name: '‡¶§‡¶•‡ßç‡¶Ø ‡¶ì ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø', short: 'ICT', def: 50 }
  ];

  // localStorage keys
  const KEY_SUBS = 'madrasah_subs_ult_v3_edit';
  const KEY_STDS = 'madrasah_stds_ult_v3_edit';
  const KEY_DEC  = 'madrasah_dec_ult_v3_edit';
  const KEY_FETCHED = 'madrasah_fetched_stds_v1'; // store fetched temporarily

  window.onload = function () {
    const savedSubjects = localStorage.getItem(KEY_SUBS);
    const savedStudents = localStorage.getItem(KEY_STDS);
    const savedDecimal  = localStorage.getItem(KEY_DEC);
    const savedFetched  = localStorage.getItem(KEY_FETCHED);

    subjectsDB.forEach((sub, index) => {
      let isChecked = index < 2 ? 'checked' : '';
      if (savedSubjects) {
        const parsed = JSON.parse(savedSubjects);
        const found = parsed.find(s => s.name === sub.name);
        if (found) isChecked = 'checked';
        else isChecked = '';
      }
      createSubjectCard(sub.name, sub.short, sub.def, isChecked);
    });

    if (savedDecimal === 'true') isDecimalEnabled = true;
    document.getElementById('decimal-toggle').checked = isDecimalEnabled;

    if (savedFetched) {
        try { fetchedStudents = JSON.parse(savedFetched); } catch(e){}
    }

    if (savedSubjects) {
      selectedSubjects = JSON.parse(savedSubjects);

      if (savedStudents) {
        allStudents = JSON.parse(savedStudents);
        if (allStudents.length > 0) {
          // Find max ID to prevent collision if API IDs are not used
          let maxId = 0;
          allStudents.forEach(s => { if(typeof s.id === 'number' && s.id < 9999) maxId = Math.max(maxId, s.id); });
          entrySerial = maxId + 1;
        }
      }

      renderInputRows();
      goToStep2UIOnly();

      if (allStudents.length > 0) {
        calculateMeritPositions();
        renderStudentTable();
        document.getElementById('merit-list-section').style.display = 'block';
      }
    }
  };

  // --- API FUNCTIONALITY ---
  async function fetchOnlineStudents() {
      const cls = document.getElementById('api-class').value;
      const yr = document.getElementById('api-year').value;
      const btn = document.getElementById('btn-fetch');

      if(!cls || !yr) { showToast('‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶õ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'warn'); return; }

      btn.innerHTML = "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
      btn.disabled = true;

      try {
        const res = await fetch(API_URL + "?action=read");
        const json = await res.json();
        if(json.status === 'success'){
          // Filter by Class and Session
          fetchedStudents = json.data.filter(s => s.ClassBn === cls && s.Session == yr);

          if(fetchedStudents.length > 0){
            showToast(`${fetchedStudents.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá!`, 'success');
            // Sort by Roll
            fetchedStudents.sort((a,b) => Number(a.Roll) - Number(b.Roll));
            localStorage.setItem(KEY_FETCHED, JSON.stringify(fetchedStudents));
          } else {
            showToast('‡¶ï‡ßã‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)', 'warn');
            fetchedStudents = [];
            localStorage.removeItem(KEY_FETCHED);
          }
        } else {
          showToast('‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá', 'danger');
        }
      } catch(e) {
        showToast('‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶è‡¶∞‡¶∞: ' + e.message, 'danger');
      } finally {
        btn.innerHTML = "Online ‡¶•‡ßá‡¶ï‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®";
        btn.disabled = false;
      }
  }

  // --- AUTO LOAD NEXT STUDENT LOGIC ---
  function loadNextStudent() {
    if(csvMode) return;
      const display = document.getElementById('active-student-info');
      
      // If no API data loaded, use Manual Serial logic
      if(fetchedStudents.length === 0) {
          currentGradingStudent = null;
          display.style.display = 'block';
          display.style.background = '#f4f7fb';
          display.style.borderColor = '#e5e7eb';
          display.style.color = '#374151';
          display.innerHTML = ` ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤: <b>${entrySerial}</b>`;
          toggleInputs(true);
          return;
      }

      // Find first student from Fetched list whose ID is NOT in allStudents
      // fetchedStudents IS ALREADY SORTED BY ROLL
      const pendingStudent = fetchedStudents.find(fs => !allStudents.some(saved => saved.id == fs.ID));

      if (pendingStudent) {
          currentGradingStudent = pendingStudent;
          display.style.display = 'block';
          // Styling for active entry
          display.style.background = '#f0fdf4';
          display.style.borderColor = '#bbf7d0';
          display.style.color = '#166534';
          display.style.borderLeftColor = '#16a34a';

          display.innerHTML = `
            <div style="font-size:13px; color:#6b7280; margin-bottom:4px;">‡¶è‡¶ñ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá (Automatic):</div>
            <div style="font-size:20px; font-weight:800; color:#15803d;">${currentGradingStudent.StudentNameEn}</div>
            <div style="display:flex; gap:15px; margin-top:6px; font-size:15px;">
               <span>Roll: <b>${currentGradingStudent.Roll}</b></span>
               <span>ID: <b>${currentGradingStudent.ID}</b></span>
            </div>
          `;
          toggleInputs(true);
          // Focus first input
          setTimeout(() => {
              const inputs = document.querySelectorAll('.input-mark');
              if(inputs.length > 0) inputs[0].focus();
          }, 200);

      } else {
          // No pending students found
          currentGradingStudent = null;
          display.style.display = 'block';
          display.style.background = '#fef2f2';
          display.style.borderColor = '#fecaca';
          display.style.color = '#b91c1c';
          display.style.borderLeftColor = '#dc2626';
          
          display.innerHTML = `‚úÖ ‡¶è‡¶á ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!`;
          toggleInputs(false); // Disable inputs
      }
  }

  function toggleInputs(enable) {
      const inputs = document.querySelectorAll('.input-mark');
      inputs.forEach(inp => {
          inp.disabled = !enable;
          if(!enable) inp.placeholder = "Locked";
          else inp.placeholder = "Mark";
      });
      document.getElementById('calculate-btn').disabled = !enable;
  }
  // --- END API FUNC ---

  function setStepPills(step){
    const p1 = document.getElementById('pill1');
    const p2 = document.getElementById('pill2');
    if(step===1){
      p1.classList.add('active'); p2.classList.remove('active');
    } else {
      p2.classList.add('active'); p1.classList.remove('active');
    }
  }

  function saveData() {
    localStorage.setItem(KEY_SUBS, JSON.stringify(selectedSubjects));
    localStorage.setItem(KEY_STDS, JSON.stringify(allStudents));
    localStorage.setItem(KEY_DEC, isDecimalEnabled);
  }

  function blurFocus(){
    try{
      const el = document.activeElement;
      if(el && typeof el.blur === 'function') el.blur();
    }catch(e){}
  }

  function clearAllData() {
    localStorage.removeItem(KEY_SUBS);
    localStorage.removeItem(KEY_STDS);
    localStorage.removeItem(KEY_DEC);
    localStorage.removeItem(KEY_FETCHED);
    location.reload();
  }

  function createSubjectCard(name, short, fullMark, checkedAttr) {
    const container = document.getElementById('subject-selection-area');
    const div = document.createElement('div');
    div.className = 'sub-card';
    div.innerHTML = `
      <div class="sub-row">
        <label class="sub-label">
          <input type="checkbox" class="sub-check" data-name="${name}" data-short="${short}" ${checkedAttr}>
          <span>${name}</span>
        </label>
        <div class="fm-wrap">
          <input type="number" class="fm-input" value="${fullMark}" min="1">
        </div>
      </div>
    `;
    container.appendChild(div);
  }

  function addNewSubject() {
    let name = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü):");
    if (name && name.trim() !== "") {
      let short = prompt("Subject Name (English - for Table):");
      if (!short) short = name;
      createSubjectCard(name.trim(), short.trim(), 100, 'checked');
    }
  }

  function toggleAutoResult(){
    autoResultEnabled = document.getElementById('auto-result-toggle').checked;
  }

  function toggleDecimal() {
    isDecimalEnabled = document.getElementById('decimal-toggle').checked;
    saveData();
  }

  function goToStep2UIOnly(){
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    setStepPills(2);
    loadNextStudent(); // Trigger Auto Load
  }

  function goToStep2() {
    selectedSubjects = [];
    const cards = document.querySelectorAll('.sub-card');

    cards.forEach(card => {
      const checkbox = card.querySelector('.sub-check');
      const fullMark = card.querySelector('.fm-input').value;
      if (checkbox.checked) {
        selectedSubjects.push({
          name: checkbox.getAttribute('data-name'),
          short: checkbox.getAttribute('data-short'),
          full: parseInt(fullMark) || 100
        });
      }
    });

    if (selectedSubjects.length === 0) {
      showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∑‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",'warn');
      return;
    }

    saveData();
    renderInputRows();
    goToStep2UIOnly();
  }

  function goBackToStep1() {
    localStorage.removeItem(KEY_SUBS);
    location.reload();
  }

  function renderInputRows() {
    const tbody = document.getElementById('input-rows');
    tbody.innerHTML = '';
    const fabH = document.getElementById('fabFocus');
    if(fabH){ fabH.style.display='none'; fabH.classList.remove('show'); }
    const stepVal = isDecimalEnabled ? "0.01" : "1";

    selectedSubjects.forEach((sub, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sub.name}</td>
        <td style="text-align:center; font-weight:1000; color:#374151;">${sub.full}</td>
        <td>
          <input type="number" class="input-mark" step="${stepVal}" data-full="${sub.full}"
            placeholder="Mark" oninput="handleInput(this, ${index})" onkeydown="handleEnter(event, ${index})">
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function handleEnter(event, index) {
    if (event.key === "Enter") {
      event.preventDefault();
      const allInputs = document.querySelectorAll('.input-mark');
      if (index === allInputs.length - 1) {
        calculateFinalResult();
      } else {
        if (index + 1 < allInputs.length) allInputs[index + 1].focus();
      }
    }
  }

  function handleInput(input, index) {
    let val = input.value;
    const fullMark = parseFloat(input.getAttribute('data-full'));
    const allInputs = document.querySelectorAll('.input-mark');
    const isLast = index === allInputs.length - 1;

    if (val !== "" && parseFloat(val) > fullMark) {
      showToast(`‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§! ‡¶è‡¶á ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶® ${fullMark}‡•§`, 'warn');
      input.value = "";
      return;
    }

    const jumpOrCalc = () => {
      if (isLast && autoResultEnabled) {
        setTimeout(() => calculateFinalResult(), 120);
      } else if (!isLast) {
        setTimeout(() => allInputs[index + 1].focus(), 90);
      }
    };

    if (!isDecimalEnabled) {
      let requiredLength = fullMark.toString().length;
      if (val.length >= requiredLength || (val !== "0" && parseInt(val) * 10 > fullMark)) {
        jumpOrCalc();
      }
    } else {
      if (val.includes('.')) {
        const parts = val.split('.');
        if (parts[1] && parts[1].length === 2) {
          jumpOrCalc();
        }
      }
    }
  }

  function getGP(percentage) {
    if (percentage >= 80) return 5.00;
    else if (percentage >= 70) return 4.00;
    else if (percentage >= 60) return 3.50;
    else if (percentage >= 50) return 3.00;
    else if (percentage >= 40) return 2.00;
    else if (percentage >= 33) return 1.00;
    else return 0.00;
  }
  
  function getGradeFromGP(gp) {
      if (gp >= 5.00) return 'A+';
      if (gp >= 4.00) return 'A';
      if (gp >= 3.50) return 'A-';
      if (gp >= 3.00) return 'B';
      if (gp >= 2.00) return 'C';
      if (gp >= 1.00) return 'D';
      return 'F';
  }

  function calculateFinalResult() {
    const inputs = document.querySelectorAll('.input-mark');
    let totalObtained = 0;
    let totalFullMarks = 0;
    let totalGP = 0;
    let failCount = 0;
    let subjectCount = inputs.length;
    let marksArray = [];

    for (let inp of inputs) {
      if (inp.value === "") {
        showToast("‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!",'warn');
        return;
      }
    }

    inputs.forEach(inp => {
      let marks = parseFloat(inp.value);
      let full = parseFloat(inp.getAttribute('data-full'));

      marksArray.push(marks);
      totalObtained += marks;
      totalFullMarks += full;

      let percent = (marks / full) * 100;
      let gp = getGP(percent);
      totalGP += gp;

      if (percent < 33) failCount++;
    });

    if (!Number.isInteger(totalObtained)) totalObtained = parseFloat(totalObtained.toFixed(2));

    let finalGPA = (totalGP / subjectCount).toFixed(2);
    let avgMarks = ((totalObtained / totalFullMarks) * 100).toFixed(2);
    if (finalGPA > 5.00) finalGPA = "5.00";

    document.getElementById('r-gpa').innerText = finalGPA;
    document.getElementById('r-total-marks').innerText = totalObtained;
    document.getElementById('r-full-marks').innerText = totalFullMarks;
    document.getElementById('r-avg').innerText = avgMarks;
    document.getElementById('r-total-gp').innerText = totalGP.toFixed(2);

    let letter = "";
    if (finalGPA == 5.00) letter = "(A+)";
    else if (finalGPA >= 4.00) letter = "(A)";
    else if (finalGPA >= 3.50) letter = "(A-)";
    else if (finalGPA >= 3.00) letter = "(B)";
    else if (finalGPA >= 2.00) letter = "(C)";
    else letter = "(D)";
    if (finalGPA < 1.00) letter = "(F)";
    document.getElementById('r-grade').innerText = letter;

    const statusElem = document.getElementById('r-status');
    document.getElementById('r-fail-count').innerText = failCount;

    if (failCount > 0) {
      statusElem.innerText = "‡¶Ö‡¶ï‡ßÉ‡¶§‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø";
      statusElem.className = "status-fail";
    } else {
      statusElem.innerText = "‡¶ï‡ßÉ‡¶§‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø";
      statusElem.className = "status-pass";
    }

    const resArea = document.getElementById('result-area');
    resArea.style.display = 'block';

    const fab = document.getElementById('fabFocus');
    if(fab){ fab.style.display = 'flex'; fab.classList.add('show'); }

    resArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // DETERMINE ID, NAME, ROLL
    let studentId = entrySerial;
    let studentName = "";
    let studentRoll = "";

    // If API student is selected and we are NOT in edit mode
    if(editModeId === null && currentGradingStudent){
        studentId = currentGradingStudent.ID;
        studentName = currentGradingStudent.StudentNameEn;
        studentRoll = currentGradingStudent.Roll;
    }

    const studentData = {
      id: editModeId !== null ? editModeId : studentId,
      total: totalObtained,
      gpa: parseFloat(finalGPA),
      isPass: (failCount === 0),
      merit: 0,
      marks: marksArray,
      grade: letter,
      failCount: failCount,
      full: totalFullMarks,
      avg: avgMarks,
      tgp: totalGP.toFixed(2),
      // NEW FIELDS
      name: editModeId !== null ? allStudents.find(s=>s.id === editModeId).name : studentName,
      roll: editModeId !== null ? allStudents.find(s=>s.id === editModeId).roll : studentRoll
    };

    if (editModeId !== null) {
      const index = allStudents.findIndex(s => s.id === editModeId);
      if (index !== -1) {
          // Preserve name/roll during edit
          studentData.name = allStudents[index].name;
          studentData.roll = allStudents[index].roll;
          allStudents[index] = studentData;
      }

      editModeId = null;
      document.getElementById('edit-message').style.display = 'none';

      const calcBtn = document.getElementById('calculate-btn');
      calcBtn.innerText = "‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®";
      calcBtn.className = "btn btn-accent";
    } else {
      // Check for Duplicate ID if using API
      const exists = allStudents.find(s => s.id == studentData.id);
      if(exists){
          // Should not happen in sequential flow, but safeguard
          const idx = allStudents.findIndex(s => s.id == studentData.id);
          allStudents[idx] = studentData;
      } else {
          allStudents.push(studentData);
          if(!currentGradingStudent) entrySerial++;
      }
    }

    saveData();
    calculateMeritPositions();
    renderStudentTable();
    document.getElementById('merit-list-section').style.display = 'block';

    inputs.forEach(inp => inp.value = '');
    
    // LOAD NEXT STUDENT IMMEDIATELY
    loadNextStudent();

    blurFocus();
    setTimeout(() => {
      const res = document.getElementById('result-area');
      if(res){
        const y = res.getBoundingClientRect().top + window.pageYOffset - 100;
        window.scrollTo({ top: y, behavior: 'smooth' });
      }
    }, 120);
  }

  function editStudent(id) {
    const student = allStudents.find(s => s.id === id);
    if (!student) return;

    const inputs = document.querySelectorAll('.input-mark');
    if (inputs.length !== student.marks.length) {
      showToast("‡¶¨‡¶ø‡¶∑‡ßü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶ì‡ßü‡¶æ‡ßü ‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§",'warn');
      return;
    }

    // Enable inputs in case they were locked
    toggleInputs(true);
document.getElementById('calculate-btn').disabled = false;
    student.marks.forEach((mark, index) => inputs[index].value = mark);
    editModeId = id;

    // Use the main display for Edit Info
    const display = document.getElementById('active-student-info');
    display.style.display = 'block';
    display.style.background = '#fffbeb';
    display.style.borderColor = '#fcd34d';
    display.style.color = '#92400e';
    display.style.borderLeftColor = '#f59e0b';
    
    display.innerHTML = `
        <div style="font-size:13px; color:#92400e; margin-bottom:4px;">‚úèÔ∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶õ‡ßá‡¶® (Edit Mode):</div>
        <div style="font-size:20px; font-weight:800; color:#b45309;">${student.name || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á'}</div>
        <div style="display:flex; gap:15px; margin-top:6px; font-size:15px;">
           <span>Roll: <b>${student.roll || '-'}</b></span>
           <span>ID: <b>${student.id}</b></span>
        </div>
    `;

    const calcBtn = document.getElementById('calculate-btn');
    calcBtn.innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Update)";
    calcBtn.className = "btn btn-warn";

    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
    inputs[0].focus();
  }

  function calculateMeritPositions() {
    let sortedList = [...allStudents];
    sortedList.sort((a, b) => {
      if (a.isPass && !b.isPass) return -1;
      if (!a.isPass && b.isPass) return 1;
      if (a.isPass && b.isPass) {
        if (b.gpa !== a.gpa) return b.gpa - a.gpa;
        return b.total - a.total;
      }
      return b.total - a.total;
    });

    sortedList.forEach((student, index) => {
      const originalStudent = allStudents.find(s => s.id === student.id);
      if (originalStudent) originalStudent.merit = index + 1;
    });
  }

  function renderStudentTable() {
    const headerRow = document.getElementById('table-headers');
    // EDITED: Header now shows SL, then hidden ID, then Name
    let headerHtml = `<th><span>SL</span></th><th class="col-id" style="display:none"><span>ID</span></th><th><span>Name</span></th><th><span>Roll</span></th>`;

    selectedSubjects.forEach(sub => headerHtml += `<th><span>${sub.short} </span></th>`);

    headerHtml += `
      <th><span>Total Marks</span></th>
      <th><span>Average (%)</span></th>
      <th><span>Full Marks</span></th>
      <th><span>Highest Mark</span></th>
      <th><span>Total GP</span></th>
      <th><span>GPA</span></th>
      <th><span>Grade</span></th>
      <th><span>Merit Position</span></th>
      <th><span>Status</span></th>
      <th class="action-col"><span>Action</span></th>
    `;
    headerRow.innerHTML = headerHtml;

    const tbody = document.getElementById('student-rows');
    tbody.innerHTML = '';

    let max = allStudents.length > 0 ? Math.max(...allStudents.map(s => s.total)) : 0;

    // Sort by Roll if available, else by ID
    allStudents.sort((a, b) => {
        if(a.roll && b.roll) return Number(a.roll) - Number(b.roll);
        return a.id - b.id;
    }).forEach((student, index) => { // Use index for SL
      let rowClass = student.isPass ? "row-pass" : "row-fail";
      let status = student.isPass ? "Pass" : `Fail(${student.failCount})`;

      let marksCells = "";
      student.marks.forEach(m => marksCells += `<td>${m}</td>`);

      // EDITED: First col is SL (index+1), second is hidden ID
      const row = `
        <tr class="${rowClass}">
          <td class="hl">${index + 1}</td>
          <td class="hl col-id" style="display:none">${student.id}</td>
          <td style="text-align:left;padding-left:8px;font-weight:700;">${student.name || '-'}</td>
          <td class="hl">${student.roll || '-'}</td>
          ${marksCells}
          <td class="hl">${student.total}</td>
          <td>${student.avg}</td>
          <td>${student.full}</td>
          <td>${max}</td>
          <td class="hl">${student.tgp}</td>
          <td class="hl">${student.gpa.toFixed(2)}</td>
          <td class="hl">${student.grade}</td>
          <td class="hl">${student.merit}</td>
          <td class="hl">${status}</td>
          <td class="action-col">
            <button class="btn-edit" onclick="editStudent(${student.id})">‚úèÔ∏è Edit</button>
          </td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  }

  // --- FIXED EXCEL DOWNLOAD FUNCTION ---
function downloadExcel() {

    if(allStudents.length === 0){
        showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á', 'warn');
        return;
    }

    let csv = [];

    // ===== HEADER ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã (‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á [100] ‡¶•‡¶æ‡¶ï‡¶¨‡ßá) =====
    let headers = ["SL","ID","Name","Roll"];

    selectedSubjects.forEach(sub=>{
        headers.push(`${sub.short} [${sub.full}]`);
    });

    headers.push("Total Marks","Average (%)","Full Marks","Highest Mark","Total GP","GPA","Grade","Merit Position","Status");

    csv.push(headers.join(","));

    // ===== DATA ROW =====
    allStudents.forEach((s, index)=>{

        let row = [
            index+1,
            s.id,
            `"${s.name}"`,
            s.roll
        ];

        s.marks.forEach(m=> row.push(m));

        row.push(
            s.total,
            s.avg,
            s.full,
            "", // highest mark optional
            s.tgp,
            s.gpa.toFixed(2),
            s.grade,
            s.merit,
            s.isPass ? "Pass" : `Fail(${s.failCount})`
        );

        csv.push(row.join(","));
    });

    let blob = new Blob(["\ufeff"+csv.join("\n")], {type:"text/csv;charset=utf-8;"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Madrasah_Result.csv";
    a.click();
}


  function handleCSVUpload(event){
    const file = event.target.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function(e){
csvMode = true;
        // ‚ö†Ô∏è ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∏‡¶¨ data delete (SAFE MODE)
        allStudents = [];
        fetchedStudents = [];
        currentGradingStudent = null;

        const rows = e.target.result.split(/\r?\n/).filter(r => r.trim());

        const headers = rows[0].split(",").map(h => h.replace(/"/g,'').trim());

        const subjectHeaders = headers.slice(4, headers.indexOf("Total Marks"));

        // Subject auto set
  selectedSubjects = subjectHeaders.map(h => {

    // Bangla [100] ‚Üí 100 ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá
    let match = h.match(/\[(\d+)\]/);
    let full = match ? Number(match[1]) : 100;

    // Bangla [100] ‚Üí Bangla
    let shortName = h.replace(/\[\d+\]/, '').trim();

    const found = subjectsDB.find(s => s.short === shortName);

    return {
        name: found ? found.name : shortName,
        short: shortName,
        full: full
    };
});

        for(let i=1;i<rows.length;i++){
            const cols = rows[i].split(",").map(c => c.replace(/"/g,'').trim());

            const marks = cols.slice(4, 4 + subjectHeaders.length)
                .map(m => Number(m) || 0);

            let total = 0;
            let totalGP = 0;
            let failCount = 0;

          marks.forEach((m, j) => {
    let percent = (m / selectedSubjects[j].full) * 100;
                let gp = getGP(percent);
                total += m;
                totalGP += gp;
                if(percent < 33) failCount++;
            });

            let gpa = (totalGP / marks.length);
            if(gpa > 5) gpa = 5;

        let totalFull = 0;
selectedSubjects.forEach(s => totalFull += s.full);

let avg = ((total / totalFull) * 100).toFixed(2);

            let grade = getGradeFromGP(gpa);

            allStudents.push({
              id: Number(cols[1]),

                name: cols[2],
                roll: cols[3],
                marks: marks,
                total: total,
                gpa: gpa,
                isPass: failCount===0,
                merit: 0,
                grade: grade,
                failCount: failCount,
               full: totalFull,

                avg: avg,
                tgp: totalGP.toFixed(2)
            });
         }

        saveData();
        calculateMeritPositions();
        renderInputRows();
        goToStep2UIOnly();
        renderStudentTable();
document.getElementById('merit-list-section').style.display = 'block';
        // üîí ENTRY LOCK
        toggleInputs(false);
        document.getElementById('calculate-btn').disabled = true;

        showToast("CSV ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá", "success");
    };

    reader.readAsText(file);
    
}
  // --- INDIVIDUAL PRINT FUNCTION ---
function printAllIndividualResults() {
    // 1. Data Validation
    if (typeof allStudents === 'undefined' || allStudents.length === 0) {
        showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶®‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø', 'warn');
        return;
    }

    // --- Helper Function: Convert English Numbers to Bengali ---
    const toBn = (n) => {
        if (n === undefined || n === null || n === '') return '-';
        return n.toString().replace(/\d/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ"[d]);
    };
    // -----------------------------------------------------------

    // 2. Exam Name Input
    let examName = prompt("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ - ‡ß®‡ß¶‡ß®‡ß¨):", "‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ - ‡ß®‡ß¶‡ß®‡ß¨");
    if (!examName || examName.trim() === "") return;
    examName = examName.split('*').join('<br>'); // Allow multiline with *
    // Convert numbers in Exam Name to Bengali automatically if user typed in English
    examName = toBn(examName); 

    // 3. Setup Variables
    const container = document.getElementById('individual-print-container');
    container.innerHTML = '';
    
    // Sort by Roll
    let printList = [...allStudents].sort((a, b) => (Number(a.roll) || 0) - (Number(b.roll) || 0));
    
   let apiClass = document.getElementById('api-class').value;

// ‡¶Ø‡¶¶‡¶ø dropdown ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ class ‡¶®‡ßá‡¶¨‡ßá
if(!apiClass && fetchedStudents.length > 0){
    apiClass = fetchedStudents[0].ClassBn;
}

// ‡¶Ø‡¶¶‡¶ø ‡¶§‡¶æ‡¶ì ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
if(!apiClass) apiClass = '---';

    // Convert Class name numbers if any
    apiClass = toBn(apiClass);

    let apiYear = document.getElementById('api-year').value || new Date().getFullYear();
    const printDate = new Date().toLocaleDateString('bn-BD'); // This usually gives Bangla digits, but we can force it in template if needed.

    // 4. Calculate Subject Highest Marks
    let subjectHighest = [];
    selectedSubjects.forEach((sub, i) => {
        let maxMark = 0;
        allStudents.forEach(st => {
            if (st.marks[i] !== undefined) {
                maxMark = Math.max(maxMark, st.marks[i]);
            }
        });
        subjectHighest.push(maxMark);
    });

    // 5. CSS Styles (Beautiful Bengali Typography)
    const cssStyles = `
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@300;400;500;600;700&display=swap');
        
        @media print {
          @page { margin: 10mm; }
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                background: white; 
            }
        }

        .print-container {
            font-family: 'Hind Siliguri', serif;
            width: 200mm;
            height: 287mm;
            padding: 0mm; 
            margin: 0 auto;
            background: white;
            box-sizing: border-box;
            page-break-after: always;
            position: relative;
        }

        /* Border Frame Design */
        .border-frame {
             border: 3px double #000;
            padding: 5px;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }
        
        .inner-content {
            border: 1px solid #ddd;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Header Section */
        .header-section {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .inst-info h1 {
            font-size: 36px; 
            color: #000;
            margin: 0;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .inst-address {
            font-size: 15px;
            color: #333;
            margin: 3px 0;
            font-weight: 500;
        }

        .exam-badge {
            background: black;
            color: white;
            padding: 5px 25px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
        }

        /* Student Info - Elegant Card */
        .student-info-card {
            display: flex;
            justify-content: space-between;
           background-color: #fff;
    border: 1px solid #000;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 15px;
        }

        .info-column {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 48%;
        }

        .info-row {
            display: flex;
            border-bottom: 1px dashed #b1dfbb;
            padding-bottom: 3px;
            font-size: 16px;
            font-weight: bold;
        }
        .info-row:last-child { border-bottom: none; }

        .info-label {
            font-weight: 700;
            color: #000;
            width: 80px;
        }
        .info-val {
            font-weight: bold;
            color: #000;
            flex-grow: 1;
        }

        /* Result Table - Font Size 14px */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px; 
            margin-bottom: 10px;
        }
        
        .result-table th {
            background-color: #eee;
    color: #000;
            padding: 4px 5px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #1a4d2e;
        }
        
        .result-table td {
            border: 1px solid #000; /* Soft Green border */
            padding: 4px 5px;
            text-align: center;
            color: #000;
          font-weight: bold;
        }
        
        .result-table td:first-child {
            text-align: left;
            padding-left: 20px;
            font-weight: 700;
            color: #000;
        }
        
        .result-table tr:nth-child(even) {
            background-color: #f9fff9;
        }

        /* Summary Section - Raised Up */
        .summary-container {
            margin-top: 10px; 
            margin-bottom: 40px;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
            background-color: #fff;
            overflow: hidden;
        }

        .summary-title {
           background-color: #eee;
    color: #000;
    border-bottom: 1px solid #000;
            text-align: center;
            font-weight: bold;
            padding: 6px;
            font-size: 16px;
        }

        .summary-content {
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            background: #fdfffd;
        }

        .summary-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            border: 1px solid #d4edda;
            border-radius: 5px;
            padding: 5px 15px;
            min-width: 90px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }

        .sum-label {
            font-size: 13px;
            color: #555;
            margin-bottom: 3px;
        }
        .sum-val {
            font-size: 17px;
            font-weight: bold;
            color: #000;
        }

        /* Signatures */
        .signature-area {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        .sig-block {
            text-align: center;
            width: 160px;
        }
        
        .sig-line {
            border-top: 1px solid #333;
            padding-top: 5px;
            font-size: 14px;
            font-weight: 700;
            color: #333;
        }

        .computer-credit {
            position: absolute;
            bottom: 8px;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: #777;
            left: 0;
        }
    </style>
    `;

    // 6. Generate Content
    let allPages = cssStyles;

    printList.forEach(std => {
      // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (API list ‡¶•‡ßá‡¶ï‡ßá)
let banglaName = std.name;

let apiStudent = fetchedStudents.find(s => s.ID == std.id);
if(apiStudent && apiStudent.StudentNameBn){
    banglaName = apiStudent.StudentNameBn;
}

        let rowsHtml = '';
        
        std.marks.forEach((m, i) => {
            if(!selectedSubjects[i]) return;
            let subObj = selectedSubjects[i];
            let percent = (m / subObj.full) * 100;
            let gp = getGP(percent);
            let grade = getGradeFromGP(gp);
            
            // Converting numbers in table rows to Bengali
            rowsHtml += `
            <tr>
                <td>${subObj.name}</td>
                <td>${toBn(subObj.full)}</td>
                <td>${toBn(m)}</td>
                <td>${toBn(subjectHighest[i])}</td>
                <td>${gp.toFixed(2)}</td>
                <td>${grade}</td> <!-- Grade letters usually kept as English (A+, B) or user needs to specify mapping -->
            </tr>`;
        });

        // Pass/Fail Logic Styling
        const resultStatus = std.isPass ? 
            `<span style="color:#155724;">‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£</span>` : 
            `<span style="color:#721c24;">‡¶Ö‡¶ï‡ßÉ‡¶§‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø</span>`;

        let pageHTML = `
        <div class="print-container">
            <div class="border-frame">
                
                <div class="inner-content">
                    
                    <!-- Header -->
                    <div class="header-section">
                        <div class="inst-info">
                            <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
                            <div class="inst-address">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ: ‡¶Æ‡ßÄ‡¶∞‡ßá‡¶∞‡¶ñ‡ßÄ‡¶≤, ‡¶°‡¶æ‡¶ï‡¶ò‡¶∞: ‡¶∏‡¶∞‡¶´‡¶≠‡¶æ‡¶ü‡¶æ, ‡¶•‡¶æ‡¶®‡¶æ: ‡¶∞‡¶æ‡¶ô‡ßç‡¶ó‡ßÅ‡¶®‡¶ø‡ßü‡¶æ, ‡¶ú‡ßá‡¶≤‡¶æ: ‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡•§</div>
                       
                            <div class="exam-badge">${examName}</div>
                        </div>
                    </div>

                    <!-- Student Info (Elegant Design with BN numbers) -->
                    <div class="student-info-card">
                        <div class="info-column">
                            <div class="info-row">
                                <span class="info-label">‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç:</span>
                                <span class="info-val">${toBn(std.id)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">‡¶®‡¶æ‡¶Æ:</span>
                                <span class="info-val">${banglaName}</span>
                            </div>
                        </div>
                        <div class="info-column">
                            <div class="info-row">
                                <span class="info-label">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</span>
                                <span class="info-val">${apiClass}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">‡¶∞‡ßã‡¶≤ ‡¶®‡¶Ç:</span>
                                <span class="info-val">${toBn(std.roll)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Marks Table (Font 14px) -->
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th width="35%">‡¶¨‡¶ø‡¶∑‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                <th width="12%">‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶Æ‡¶æ‡¶®</th>
                                <th width="15%">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                                <th width="15%">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö</th>
                                <th width="10%">‡¶ú‡¶ø‡¶™‡¶ø</th>
                                <th width="13%">‡¶ó‡ßç‡¶∞‡ßá‡¶°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>

                    <!-- Summary Section (Raised Up, BN Numbers) -->
                    <div class="summary-container">
                        <div class="summary-title">‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡ßÄ</div>
                        <div class="summary-content">
                            <div class="summary-badge">
                                <span class="sum-label">‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span>
                                <span class="sum-val">${toBn(std.total)}</span>
                            </div>
                            <div class="summary-badge">
                                <span class="sum-label">‡¶ú‡¶ø‡¶™‡¶ø‡¶è</span>
                                <span class="sum-val">${std.gpa.toFixed(2)}</span>
                            </div>
                            <div class="summary-badge">
                                <span class="sum-label">‡¶ó‡ßç‡¶∞‡ßá‡¶°</span>
                                <span class="sum-val">${std.grade}</span>
                            </div>
                            <div class="summary-badge">
                                <span class="sum-label">‡¶Æ‡ßá‡¶ß‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®</span>
                                <span class="sum-val">${toBn(std.merit)}</span>
                            </div>
                            <div class="summary-badge">
                                <span class="sum-label">‡¶´‡¶≤‡¶æ‡¶´‡¶≤</span>
                                <span class="sum-val">${resultStatus}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Signatures -->
                    <div class="signature-area">
                        <div class="sig-block">
                            <div class="sig-line">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï</div>
                        </div>
                        <div class="sig-block">
                            <div class="sig-line">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï</div>
                        </div>
                        <div class="sig-block">
                            <div class="sig-line">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶ü</div>
                        </div>
                    </div>

                    <div class="computer-credit">
                        ‡¶á‡¶∏‡ßç‡¶Ø‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${toBn(printDate)} | ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ï‡¶æ‡¶∞‡¶ï: ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
                    </div>
                </div>
            </div>
        </div>
        `;
        allPages += pageHTML;
    });

    // 7. Inject and Print
    container.innerHTML = allPages;
    document.body.classList.add('print-mode-individual');
    
    // Allow images to load before print dialog
    setTimeout(() => {
        window.print();
        setTimeout(() => {
            document.body.classList.remove('print-mode-individual');
        }, 500);
    }, 500);
}
// Make entire subject card clickable (without breaking checkbox/label clicks)
  document.addEventListener('click', function(e){
    const card = e.target.closest('.sub-card');
    if(!card) return;

    if (e.target.classList.contains('sub-check')) return;
    if (e.target.closest('label')) return;
    if(e.target.classList.contains('fm-input')) return;

    const checkbox = card.querySelector('.sub-check');
    if(checkbox){ checkbox.checked = !checkbox.checked; }
  });

  function focusFirstMarkInput(){
    const first = document.querySelector('.input-mark');
    if(!first) return;
    try{ first.focus(); }catch(e){}
    try{ first.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){ first.scrollIntoView(); }
  }
  function printResultList() {

    if(allStudents.length === 0){
        showToast('‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶®‡ßá‡¶á', 'warn');
        return;
    }

    let examName = prompt("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ - ‡ß®‡ß¶‡ß®‡ß¨):", "‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ - ‡ß®‡ß¶‡ß®‡ß¨");
    if(!examName || examName.trim() === "") return;

    examName = examName.split('*').join('<br>');

    const head = document.querySelector('.print-head');
    head.style.display = 'block';

    head.innerHTML = `
        <h1>‡¶Ü‡¶¨‡¶¶‡ßÅ‡¶∞ ‡¶∞‡¶æ‡¶ú‡ßç‡¶ú‡¶æ‡¶ï ‡¶¶‡¶æ‡¶ñ‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
        <h2>${examName}</h2>
        <p>‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
    `;

    window.print();

    // üëâ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ hide
    setTimeout(() => {
        head.style.display = 'none';
    }, 100);
}


</script>
</body>
</html>
